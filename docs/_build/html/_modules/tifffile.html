<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tifffile &mdash; Embryo Pre-processing 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Embryo Pre-processing 0.0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Embryo Pre-processing 0.0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tifffile</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># tifffile.py</span>
<span class="c"># Copyright (c) 2008-2014, Christoph Gohlke</span>
<span class="c"># Copyright (c) 2008-2014, The Regents of the University of California</span>
<span class="c"># Produced at the Laboratory for Fluorescence Dynamics</span>
<span class="c"># All rights reserved.</span>
<span class="c">#</span>
<span class="c"># Redistribution and use in source and binary forms, with or without</span>
<span class="c"># modification, are permitted provided that the following conditions are met:</span>
<span class="c">#</span>
<span class="c"># * Redistributions of source code must retain the above copyright</span>
<span class="c">#   notice, this list of conditions and the following disclaimer.</span>
<span class="c"># * Redistributions in binary form must reproduce the above copyright</span>
<span class="c">#   notice, this list of conditions and the following disclaimer in the</span>
<span class="c">#   documentation and/or other materials provided with the distribution.</span>
<span class="c"># * Neither the name of the copyright holders nor the names of any</span>
<span class="c">#   contributors may be used to endorse or promote products derived</span>
<span class="c">#   from this software without specific prior written permission.</span>
<span class="c">#</span>
<span class="c"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c"># ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="c"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c"># POSSIBILITY OF SUCH DAMAGE.</span>
<span class="sd">&quot;&quot;&quot;Read and write image data from and to TIFF files.</span>
<span class="sd">Image and meta-data can be read from TIFF, BigTIFF, OME-TIFF, STK, LSM, NIH,</span>
<span class="sd">ImageJ, MicroManager, FluoView, SEQ and GEL files.</span>
<span class="sd">Only a subset of the TIFF specification is supported, mainly uncompressed</span>
<span class="sd">and losslessly compressed 2**(0 to 6) bit integer, 16, 32 and 64-bit float,</span>
<span class="sd">grayscale and RGB(A) images, which are commonly used in bio-scientific imaging.</span>
<span class="sd">Specifically, reading JPEG/CCITT compressed image data or EXIF/IPTC/GPS/XMP</span>
<span class="sd">meta-data is not implemented. Only primary info records are read for STK,</span>
<span class="sd">FluoView, MicroManager, and NIH image formats.</span>
<span class="sd">TIFF, the Tagged Image File Format, is under the control of Adobe Systems.</span>
<span class="sd">BigTIFF allows for files greater than 4 GB. STK, LSM, FluoView, SEQ, GEL,</span>
<span class="sd">and OME-TIFF, are custom extensions defined by MetaMorph, Carl Zeiss</span>
<span class="sd">MicroImaging, Olympus, Media Cybernetics, Molecular Dynamics, and the Open</span>
<span class="sd">Microscopy Environment consortium respectively.</span>
<span class="sd">For command line usage run ``python tifffile.py --help``</span>
<span class="sd">:Author:</span>
<span class="sd">  `Christoph Gohlke &lt;http://www.lfd.uci.edu/~gohlke/&gt;`_</span>
<span class="sd">:Organization:</span>
<span class="sd">  Laboratory for Fluorescence Dynamics, University of California, Irvine</span>
<span class="sd">:Version: 2014.02.05</span>
<span class="sd">Requirements</span>
<span class="sd">------------</span>
<span class="sd">* `CPython 2.7 or 3.3 &lt;http://www.python.org&gt;`_</span>
<span class="sd">* `Numpy 1.7 &lt;http://www.numpy.org&gt;`_</span>
<span class="sd">* `Matplotlib 1.3 &lt;http://www.matplotlib.org&gt;`_  (optional for plotting)</span>
<span class="sd">* `Tifffile.c 2013.01.18 &lt;http://www.lfd.uci.edu/~gohlke/&gt;`_</span>
<span class="sd">  (recommended for faster decoding of PackBits and LZW encoded strings)</span>
<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">The API is not stable yet and might change between revisions.</span>
<span class="sd">Tested on little-endian platforms only.</span>
<span class="sd">Other Python packages and modules for reading bio-scientific TIFF files:</span>
<span class="sd">* `Imread &lt;http://luispedro.org/software/imread&gt;`_</span>
<span class="sd">* `PyLibTiff &lt;http://code.google.com/p/pylibtiff&gt;`_</span>
<span class="sd">* `SimpleITK &lt;http://www.simpleitk.org&gt;`_</span>
<span class="sd">* `PyLSM &lt;https://launchpad.net/pylsm&gt;`_</span>
<span class="sd">* `PyMca.TiffIO.py &lt;http://pymca.sourceforge.net/&gt;`_</span>
<span class="sd">* `BioImageXD.Readers &lt;http://www.bioimagexd.net/&gt;`_</span>
<span class="sd">* `Cellcognition.io &lt;http://cellcognition.org/&gt;`_</span>
<span class="sd">* `CellProfiler.bioformats &lt;http://www.cellprofiler.org/&gt;`_</span>
<span class="sd">Acknowledgements</span>
<span class="sd">----------------</span>
<span class="sd">*  Egor Zindy, University of Manchester, for cz_lsm_scan_info specifics.</span>
<span class="sd">*  Wim Lewis for a bug fix and some read_cz_lsm functions.</span>
<span class="sd">*  Hadrien Mary for help on reading MicroManager files.</span>
<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">(1) TIFF 6.0 Specification and Supplements. Adobe Systems Incorporated.</span>
<span class="sd">    http://partners.adobe.com/public/developer/tiff/</span>
<span class="sd">(2) TIFF File Format FAQ. http://www.awaresystems.be/imaging/tiff/faq.html</span>
<span class="sd">(3) MetaMorph Stack (STK) Image File Format.</span>
<span class="sd">    http://support.meta.moleculardevices.com/docs/t10243.pdf</span>
<span class="sd">(4) File Format Description - LSM 5xx Release 2.0.</span>
<span class="sd">    http://ibb.gsf.de/homepage/karsten.rodenacker/IDL/Lsmfile.doc</span>
<span class="sd">(5) BioFormats. http://www.loci.wisc.edu/ome/formats.html</span>
<span class="sd">(6) The OME-TIFF format.</span>
<span class="sd">    http://www.openmicroscopy.org/site/support/file-formats/ome-tiff</span>
<span class="sd">(7) TiffDecoder.java</span>
<span class="sd">    http://rsbweb.nih.gov/ij/developer/source/ij/io/TiffDecoder.java.html</span>
<span class="sd">(8) UltraQuant(r) Version 6.0 for Windows Start-Up Guide.</span>
<span class="sd">    http://www.ultralum.com/images%20ultralum/pdf/UQStart%20Up%20Guide.pdf</span>
<span class="sd">(9) Micro-Manager File Formats.</span>
<span class="sd">    http://www.micro-manager.org/wiki/Micro-Manager_File_Formats</span>
<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">&gt;&gt;&gt; data = numpy.random.rand(301, 219)</span>
<span class="sd">&gt;&gt;&gt; imsave(&#39;temp.tif&#39;, data)</span>
<span class="sd">&gt;&gt;&gt; image = imread(&#39;temp.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; assert numpy.all(image == data)</span>
<span class="sd">&gt;&gt;&gt; tif = TiffFile(&#39;test.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; images = tif.asarray()</span>
<span class="sd">&gt;&gt;&gt; image0 = tif[0].asarray()</span>
<span class="sd">&gt;&gt;&gt; for page in tif:</span>
<span class="sd">...     for tag in page.tags.values():</span>
<span class="sd">...         t = tag.name, tag.value</span>
<span class="sd">...     image = page.asarray()</span>
<span class="sd">...     if page.is_rgb: pass</span>
<span class="sd">...     if page.is_palette:</span>
<span class="sd">...         t = page.color_map</span>
<span class="sd">...     if page.is_stk:</span>
<span class="sd">...         t = page.mm_uic_tags.number_planes</span>
<span class="sd">...     if page.is_lsm:</span>
<span class="sd">...         t = page.cz_lsm_info</span>
<span class="sd">&gt;&gt;&gt; tif.close()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">cElementTree</span> <span class="k">as</span> <span class="n">ElementTree</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;2014.02.05&#39;</span>
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s">&#39;restructuredtext en&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;imsave&#39;</span><span class="p">,</span> <span class="s">&#39;imread&#39;</span><span class="p">,</span> <span class="s">&#39;imshow&#39;</span><span class="p">,</span> <span class="s">&#39;TiffFile&#39;</span><span class="p">,</span> <span class="s">&#39;TiffSequence&#39;</span><span class="p">]</span>
<div class="viewcode-block" id="imsave"><a class="viewcode-back" href="../tifffile.html#tifffile.imsave">[docs]</a><span class="k">def</span> <span class="nf">imsave</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">planarconfig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">resolution</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="s">&#39;tifffile.py&#39;</span><span class="p">,</span>
           <span class="n">byteorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bigtiff</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">extratags</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Write image data to TIFF file.</span>
<span class="sd">    Image data are written in one stripe per plane.</span>
<span class="sd">    Dimensions larger than 2 or 3 (depending on photometric mode and</span>
<span class="sd">    planar configuration) are flattened and saved as separate pages.</span>
<span class="sd">    The &#39;sample_format&#39; and &#39;bits_per_sample&#39; TIFF tags are derived from</span>
<span class="sd">    the data type.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of file to write.</span>
<span class="sd">    data : array_like</span>
<span class="sd">        Input image. The last dimensions are assumed to be image height,</span>
<span class="sd">        width, and samples.</span>
<span class="sd">    photometric : {&#39;minisblack&#39;, &#39;miniswhite&#39;, &#39;rgb&#39;}</span>
<span class="sd">        The color space of the image data.</span>
<span class="sd">        By default this setting is inferred from the data shape.</span>
<span class="sd">    planarconfig : {&#39;contig&#39;, &#39;planar&#39;}</span>
<span class="sd">        Specifies if samples are stored contiguous or in separate planes.</span>
<span class="sd">        By default this setting is inferred from the data shape.</span>
<span class="sd">        &#39;contig&#39;: last dimension contains samples.</span>
<span class="sd">        &#39;planar&#39;: third last dimension contains samples.</span>
<span class="sd">    resolution : (float, float) or ((int, int), (int, int))</span>
<span class="sd">        X and Y resolution in dots per inch as float or rational numbers.</span>
<span class="sd">    description : str</span>
<span class="sd">        The subject of the image. Saved with the first page only.</span>
<span class="sd">    software : str</span>
<span class="sd">        Name of the software used to create the image.</span>
<span class="sd">        Saved with the first page only.</span>
<span class="sd">    byteorder : {&#39;&lt;&#39;, &#39;&gt;&#39;}</span>
<span class="sd">        The endianness of the data in the file.</span>
<span class="sd">        By default this is the system&#39;s native byte order.</span>
<span class="sd">    bigtiff : bool</span>
<span class="sd">        If True, the BigTIFF format is used.</span>
<span class="sd">        By default the standard TIFF format is used for data less than 2000 MB.</span>
<span class="sd">    compress : int</span>
<span class="sd">        Values from 0 to 9 controlling the level of zlib compression.</span>
<span class="sd">        If 0, data are written uncompressed (default).</span>
<span class="sd">    extratags: sequence of tuples</span>
<span class="sd">        Additional tags as [(code, dtype, count, value, writeonce)].</span>
<span class="sd">        code : int</span>
<span class="sd">            The TIFF tag Id.</span>
<span class="sd">        dtype : str</span>
<span class="sd">            Data type of items in `value` in Python struct format.</span>
<span class="sd">            One of B, s, H, I, 2I, b, h, i, f, d, Q, or q.</span>
<span class="sd">        count : int</span>
<span class="sd">            Number of data values. Not used for string values.</span>
<span class="sd">        value : sequence</span>
<span class="sd">            `Count` values compatible with `dtype`.</span>
<span class="sd">        writeonce : bool</span>
<span class="sd">            If True, the tag is written to the first page only.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.ones((2, 5, 3, 301, 219), &#39;float32&#39;) * 0.5</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp.tif&#39;, data, compress=6)</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.ones((5, 301, 219, 3), &#39;uint8&#39;) + 127</span>
<span class="sd">    &gt;&gt;&gt; value = u&#39;{&quot;shape&quot;: %s}&#39; % str(list(data.shape))</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp.tif&#39;, data, extratags=[(270, &#39;s&#39;, 0, value, True)])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;minisblack&#39;</span><span class="p">,</span> <span class="s">&#39;miniswhite&#39;</span><span class="p">,</span> <span class="s">&#39;rgb&#39;</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">planarconfig</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;contig&#39;</span><span class="p">,</span> <span class="s">&#39;planar&#39;</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">byteorder</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">compress</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="s">&#39;&lt;&#39;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s">&#39;little&#39;</span> <span class="k">else</span> <span class="s">&#39;&gt;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">byteorder</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bigtiff</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">:</span>
        <span class="n">bigtiff</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">offset_size</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">tag_size</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">numtag_format</span> <span class="o">=</span> <span class="s">&#39;H&#39;</span>
        <span class="n">offset_format</span> <span class="o">=</span> <span class="s">&#39;I&#39;</span>
        <span class="n">val_format</span> <span class="o">=</span> <span class="s">&#39;4s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bigtiff</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">offset_size</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">tag_size</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">numtag_format</span> <span class="o">=</span> <span class="s">&#39;Q&#39;</span>
        <span class="n">offset_format</span> <span class="o">=</span> <span class="s">&#39;Q&#39;</span>
        <span class="n">val_format</span> <span class="o">=</span> <span class="s">&#39;8s&#39;</span>
    <span class="c"># unify shape of data</span>
    <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">extrasamples</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="s">&#39;rgb&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="s">&#39;minisblack&#39;</span>
    <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a RGB(A) image&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">planarconfig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="s">&#39;planar&#39;</span> <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;contig&#39;</span>
        <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a contiguous RGB(A) image&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
            <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a planar RGB(A) image&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">samplesperpixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">extrasamples</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">planarconfig</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
            <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">extrasamples</span> <span class="o">=</span> <span class="n">samplesperpixel</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">planarconfig</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># remove trailing 1s</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>  <span class="c"># (pages, planes, height, width, contig samples)</span>
    <span class="n">bytestr</span> <span class="o">=</span> <span class="nb">bytes</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;2&#39;</span> <span class="k">else</span> <span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">tifftypes</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;B&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;2I&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                 <span class="s">&#39;h&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&#39;Q&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">}</span>
    <span class="n">tifftags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;new_subfile_type&#39;</span><span class="p">:</span> <span class="mi">254</span><span class="p">,</span> <span class="s">&#39;subfile_type&#39;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
        <span class="s">&#39;image_width&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">&#39;image_length&#39;</span><span class="p">:</span> <span class="mi">257</span><span class="p">,</span> <span class="s">&#39;bits_per_sample&#39;</span><span class="p">:</span> <span class="mi">258</span><span class="p">,</span>
        <span class="s">&#39;compression&#39;</span><span class="p">:</span> <span class="mi">259</span><span class="p">,</span> <span class="s">&#39;photometric&#39;</span><span class="p">:</span> <span class="mi">262</span><span class="p">,</span> <span class="s">&#39;fill_order&#39;</span><span class="p">:</span> <span class="mi">266</span><span class="p">,</span>
        <span class="s">&#39;document_name&#39;</span><span class="p">:</span> <span class="mi">269</span><span class="p">,</span> <span class="s">&#39;image_description&#39;</span><span class="p">:</span> <span class="mi">270</span><span class="p">,</span> <span class="s">&#39;strip_offsets&#39;</span><span class="p">:</span> <span class="mi">273</span><span class="p">,</span>
        <span class="s">&#39;orientation&#39;</span><span class="p">:</span> <span class="mi">274</span><span class="p">,</span> <span class="s">&#39;samples_per_pixel&#39;</span><span class="p">:</span> <span class="mi">277</span><span class="p">,</span> <span class="s">&#39;rows_per_strip&#39;</span><span class="p">:</span> <span class="mi">278</span><span class="p">,</span>
        <span class="s">&#39;strip_byte_counts&#39;</span><span class="p">:</span> <span class="mi">279</span><span class="p">,</span> <span class="s">&#39;x_resolution&#39;</span><span class="p">:</span> <span class="mi">282</span><span class="p">,</span> <span class="s">&#39;y_resolution&#39;</span><span class="p">:</span> <span class="mi">283</span><span class="p">,</span>
        <span class="s">&#39;planar_configuration&#39;</span><span class="p">:</span> <span class="mi">284</span><span class="p">,</span> <span class="s">&#39;page_name&#39;</span><span class="p">:</span> <span class="mi">285</span><span class="p">,</span> <span class="s">&#39;resolution_unit&#39;</span><span class="p">:</span> <span class="mi">296</span><span class="p">,</span>
        <span class="s">&#39;software&#39;</span><span class="p">:</span> <span class="mi">305</span><span class="p">,</span> <span class="s">&#39;datetime&#39;</span><span class="p">:</span> <span class="mi">306</span><span class="p">,</span> <span class="s">&#39;predictor&#39;</span><span class="p">:</span> <span class="mi">317</span><span class="p">,</span> <span class="s">&#39;color_map&#39;</span><span class="p">:</span> <span class="mi">320</span><span class="p">,</span>
        <span class="s">&#39;extra_samples&#39;</span><span class="p">:</span> <span class="mi">338</span><span class="p">,</span> <span class="s">&#39;sample_format&#39;</span><span class="p">:</span> <span class="mi">339</span><span class="p">}</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># list of (code, ifdentry, ifdvalue, writeonce)</span>
    <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">addtag</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c"># compute ifdentry and ifdvalue bytes from code, dtype, count, value</span>
        <span class="c"># append (code, ifdentry, ifdvalue, writeonce) to tags list</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">tifftags</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">tifftags</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tifftypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unknown dtype </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">tifftype</span> <span class="o">=</span> <span class="n">tifftypes</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="n">rawcount</span> <span class="o">=</span> <span class="n">count</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytestr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">rawcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ifdentry</span> <span class="o">=</span> <span class="p">[</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;HH&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">tifftype</span><span class="p">),</span>
                    <span class="n">pack</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="n">rawcount</span><span class="p">)]</span>
        <span class="n">ifdvalue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">val_format</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">offset_size</span><span class="p">:</span>
            <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">val_format</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ifdentry</span><span class="p">),</span> <span class="n">ifdvalue</span><span class="p">,</span> <span class="n">writeonce</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">rational</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">max_denominator</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="c"># return nominator and denominator from float or two integers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="n">max_denominator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">denominator</span>
    <span class="k">if</span> <span class="n">software</span><span class="p">:</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;software&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">software</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;image_description&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shape</span> <span class="o">!=</span> <span class="n">data_shape</span><span class="p">:</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;image_description&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s">&quot;shape=(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_shape</span><span class="p">)),</span>
               <span class="n">writeonce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;datetime&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
           <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y:%m:</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">),</span>
           <span class="n">writeonce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;compression&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32946</span> <span class="k">if</span> <span class="n">compress</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;orientation&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;image_width&#39;</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;image_length&#39;</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;new_subfile_type&#39;</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;sample_format&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
           <span class="p">{</span><span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}[</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span><span class="p">])</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;photometric&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
           <span class="p">{</span><span class="s">&#39;miniswhite&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;minisblack&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;rgb&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}[</span><span class="n">photometric</span><span class="p">])</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;samples_per_pixel&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">planarconfig</span><span class="p">:</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;planar_configuration&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">planarconfig</span><span class="o">==</span><span class="s">&#39;contig&#39;</span>
               <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;bits_per_sample&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span>
               <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="n">samplesperpixel</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;bits_per_sample&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extrasamples</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s">&#39;rgb&#39;</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;extra_samples&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># alpha channel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;extra_samples&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="n">extrasamples</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="n">extrasamples</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resolution</span><span class="p">:</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;x_resolution&#39;</span><span class="p">,</span> <span class="s">&#39;2I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rational</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;y_resolution&#39;</span><span class="p">,</span> <span class="s">&#39;2I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rational</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;resolution_unit&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;rows_per_strip&#39;</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="c"># use one strip per plane</span>
    <span class="n">strip_byte_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;strip_byte_counts&#39;</span><span class="p">,</span> <span class="n">offset_format</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strip_byte_counts</span><span class="p">)</span>
    <span class="n">addtag</span><span class="p">(</span><span class="s">&#39;strip_offsets&#39;</span><span class="p">,</span> <span class="n">offset_format</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c"># add extra tags from users</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">extratags</span><span class="p">:</span>
        <span class="n">addtag</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
    <span class="c"># the entries in an IFD must be sorted in ascending order by tag code</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">seek</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">seek</span>
        <span class="n">tell</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span>
        <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">write</span><span class="p">({</span><span class="s">&#39;&lt;&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;II&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;MM&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bigtiff</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="s">&#39;HHH&#39;</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
        <span class="n">ifd_offset</span> <span class="o">=</span> <span class="n">tell</span><span class="p">()</span>
        <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c"># first IFD</span>
        <span class="k">for</span> <span class="n">pageindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c"># update pointer at ifd_offset</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">tell</span><span class="p">()</span>
            <span class="n">seek</span><span class="p">(</span><span class="n">ifd_offset</span><span class="p">)</span>
            <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
            <span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="c"># write ifdentries</span>
            <span class="n">write</span><span class="p">(</span><span class="n">numtag_format</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
            <span class="n">tag_offset</span> <span class="o">=</span> <span class="n">tell</span><span class="p">()</span>
            <span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">))</span>
            <span class="n">ifd_offset</span> <span class="o">=</span> <span class="n">tell</span><span class="p">()</span>
            <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c"># offset to next IFD</span>
            <span class="c"># write tag values and patch offsets in ifdentries, if necessary</span>
            <span class="k">for</span> <span class="n">tagindex</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">tell</span><span class="p">()</span>
                    <span class="n">seek</span><span class="p">(</span><span class="n">tag_offset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="o">*</span><span class="n">tag_size</span> <span class="o">+</span> <span class="n">offset_size</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                    <span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">273</span><span class="p">:</span>
                        <span class="n">strip_offsets_offset</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="k">elif</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">279</span><span class="p">:</span>
                        <span class="n">strip_byte_counts_offset</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="n">write</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="c"># write image data</span>
            <span class="n">data_offset</span> <span class="o">=</span> <span class="n">tell</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                <span class="n">strip_byte_counts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">pageindex</span><span class="p">]:</span>
                    <span class="n">plane</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">compress</span><span class="p">)</span>
                    <span class="n">strip_byte_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plane</span><span class="p">))</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># if this fails try update Python/numpy</span>
                <span class="n">data</span><span class="p">[</span><span class="n">pageindex</span><span class="p">]</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c"># update strip_offsets and strip_byte_counts if necessary</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">tell</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tagindex</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">273</span><span class="p">:</span>  <span class="c"># strip_offsets</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">seek</span><span class="p">(</span><span class="n">strip_offsets_offset</span><span class="p">)</span>
                        <span class="n">strip_offset</span> <span class="o">=</span> <span class="n">data_offset</span>
                        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">strip_byte_counts</span><span class="p">:</span>
                            <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="n">strip_offset</span><span class="p">)</span>
                            <span class="n">strip_offset</span> <span class="o">+=</span> <span class="n">size</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">seek</span><span class="p">(</span><span class="n">tag_offset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="o">*</span><span class="n">tag_size</span> <span class="o">+</span> <span class="n">offset_size</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">279</span><span class="p">:</span>  <span class="c"># strip_byte_counts</span>
                    <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">seek</span><span class="p">(</span><span class="n">strip_byte_counts_offset</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">strip_byte_counts</span><span class="p">:</span>
                                <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">seek</span><span class="p">(</span><span class="n">tag_offset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="o">*</span><span class="n">tag_size</span> <span class="o">+</span>
                                 <span class="n">offset_size</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                            <span class="n">write</span><span class="p">(</span><span class="n">offset_format</span><span class="p">,</span> <span class="n">strip_byte_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">break</span>
            <span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c"># remove tags that should be written only once</span>
            <span class="k">if</span> <span class="n">pageindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span></div>
<div class="viewcode-block" id="imread"><a class="viewcode-back" href="../tifffile.html#tifffile.imread">[docs]</a><span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image data from TIFF file(s) as numpy array.</span>
<span class="sd">    The first image series is returned if no arguments are provided.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : str or list</span>
<span class="sd">        File name, glob pattern, or list of file names.</span>
<span class="sd">    key : int, slice, or sequence of page indices</span>
<span class="sd">        Defines which pages to return as array.</span>
<span class="sd">    series : int</span>
<span class="sd">        Defines which series of pages in file to return as array.</span>
<span class="sd">    multifile : bool</span>
<span class="sd">        If True (default), OME-TIFF data may include pages from multiple files.</span>
<span class="sd">    pattern : str</span>
<span class="sd">        Regular expression pattern that matches axes names and indices in</span>
<span class="sd">        file names.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; im = imread(&#39;test.tif&#39;, 0)</span>
<span class="sd">    &gt;&gt;&gt; im.shape</span>
<span class="sd">    (256, 256, 4)</span>
<span class="sd">    &gt;&gt;&gt; ims = imread([&#39;test.tif&#39;, &#39;test.tif&#39;])</span>
<span class="sd">    &gt;&gt;&gt; ims.shape</span>
<span class="sd">    (2, 256, 256, 4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs_file</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s">&#39;multifile&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs_file</span><span class="p">[</span><span class="s">&#39;multifile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;multifile&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;multifile&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs_file</span><span class="p">[</span><span class="s">&#39;multifile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">kwargs_seq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s">&#39;pattern&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs_seq</span><span class="p">[</span><span class="s">&#39;pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;pattern&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;pattern&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s">&#39;?*&#39;</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;no files found&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">TiffSequence</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_seq</span><span class="p">)</span> <span class="k">as</span> <span class="n">imseq</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">imseq</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<span class="k">class</span> <span class="nc">lazyattr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lazy object attribute whose value is computed on first access.&quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;func&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">instance</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
<div class="viewcode-block" id="TiffFile"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile">[docs]</a><span class="k">class</span> <span class="nc">TiffFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read image and meta-data from TIFF, STK, LSM, and FluoView files.</span>
<span class="sd">    TiffFile instances must be closed using the close method, which is</span>
<span class="sd">    automatically called when using the &#39;with&#39; statement.</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    pages : list</span>
<span class="sd">        All TIFF pages in file.</span>
<span class="sd">    series : list of Records(shape, dtype, axes, TiffPages)</span>
<span class="sd">        TIFF pages with compatible shapes and types.</span>
<span class="sd">    micromanager_metadata: dict</span>
<span class="sd">        Extra MicroManager non-TIFF metadata in the file, if exists.</span>
<span class="sd">    All attributes are read-only.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; tif = TiffFile(&#39;test.tif&#39;)</span>
<span class="sd">    ... try:</span>
<span class="sd">    ...     images = tif.asarray()</span>
<span class="sd">    ... except Exception as e:</span>
<span class="sd">    ...     print(e)</span>
<span class="sd">    ... finally:</span>
<span class="sd">    ...     tif.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">multifile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg : str or open file</span>
<span class="sd">            Name of file or open file object.</span>
<span class="sd">            The file objects are closed in TiffFile.close().</span>
<span class="sd">        name : str</span>
<span class="sd">            Human readable label of open file.</span>
<span class="sd">        multifile : bool</span>
<span class="sd">            If True, series may include pages from multiple files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>  <span class="c"># cache of TiffFiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_size</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multifile</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">multifile</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fromfile</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>
<div class="viewcode-block" id="TiffFile.close"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close open file handle(s).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tif</span><span class="o">.</span><span class="n">_fh</span><span class="p">:</span>
                <span class="n">tif</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">tif</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span> <span class="o">=</span> <span class="p">{}</span></div>
    <span class="k">def</span> <span class="nf">_fromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read TIFF header and all page records from file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="s">&#39;II&#39;</span><span class="p">:</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;MM&#39;</span><span class="p">:</span> <span class="s">&#39;&gt;&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a valid TIFF file&quot;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">43</span><span class="p">:</span>  <span class="c"># BigTiff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_size</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;HH&#39;</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">zero</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a valid BigTIFF file&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">42</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_size</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a TIFF file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;empty TIFF file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_micromanager</span><span class="p">:</span>
            <span class="c"># MicroManager files contain metadata not stored in TIFF tags.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">micromanager_metadata</span> <span class="o">=</span> <span class="n">read_micromanager_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">)</span>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.series"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.series">[docs]</a>    <span class="k">def</span> <span class="nf">series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return series of TiffPage with compatible shape and properties.&quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omeseries</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fluoview</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;Y&#39;</span><span class="p">:</span> <span class="s">&#39;Y&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;Z&#39;</span><span class="p">:</span> <span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;T&#39;</span><span class="p">:</span> <span class="s">&#39;T&#39;</span><span class="p">,</span>
                    <span class="n">b</span><span class="s">&#39;WAVELENGTH&#39;</span><span class="p">:</span> <span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;TIME&#39;</span><span class="p">:</span> <span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;XY&#39;</span><span class="p">:</span> <span class="s">&#39;R&#39;</span><span class="p">,</span>
                    <span class="n">b</span><span class="s">&#39;EVENT&#39;</span><span class="p">:</span> <span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;EXPOSURE&#39;</span><span class="p">:</span> <span class="s">&#39;L&#39;</span><span class="p">}</span>
            <span class="n">mmhd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mm_header</span><span class="o">.</span><span class="n">dimensions</span><span class="p">))</span>
            <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Record</span><span class="p">(</span>
                <span class="n">axes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s">&#39;Q&#39;</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmhd</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">shape</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmhd</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="n">lsmi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cz_lsm_info</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">CZ_SCAN_TYPES</span><span class="p">[</span><span class="n">lsmi</span><span class="o">.</span><span class="n">scan_type</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;XY&#39;</span><span class="p">,</span> <span class="s">&#39;XYC&#39;</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">lsmi</span><span class="p">,</span> <span class="n">CZ_DIMENSIONS</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_reduced</span><span class="p">]</span>
            <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Record</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="n">pages</span><span class="p">,</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>  <span class="c"># reduced RGB pages</span>
                <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_reduced</span><span class="p">]</span>
                <span class="n">cp</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">cp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">cp</span> <span class="o">*=</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;CYX&#39;</span>
                <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Record</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="n">pages</span><span class="p">,</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_imagej</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imagej_tags</span>
            <span class="k">if</span> <span class="s">&#39;frames&#39;</span> <span class="ow">in</span> <span class="n">ij</span><span class="p">:</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">])</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;slices&#39;</span> <span class="ow">in</span> <span class="n">ij</span><span class="p">:</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="s">&#39;slices&#39;</span><span class="p">])</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;channels&#39;</span> <span class="ow">in</span> <span class="n">ij</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="s">&#39;channels&#39;</span><span class="p">])</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="n">remain</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">shape</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remain</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">)</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
            <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Record</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nih</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Record</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span>
                             <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                             <span class="n">axes</span><span class="o">=</span><span class="s">&#39;I&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;image_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
            <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Record</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                             <span class="n">axes</span><span class="o">=</span><span class="s">&#39;Q&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                                      <span class="n">page</span><span class="o">.</span><span class="n">compression</span> <span class="ow">in</span> <span class="n">TIFF_DECOMPESSORS</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
                    <span class="n">shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">pages</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pages</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Record</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="n">pages</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                             <span class="n">axes</span><span class="o">=</span><span class="p">((</span><span class="s">&#39;I&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                                   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                             <span class="n">shape</span><span class="o">=</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">s</span><span class="p">]),</span> <span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
                      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">series</span></div>
<div class="viewcode-block" id="TiffFile.asarray"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.asarray">[docs]</a>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data of multiple TIFF pages as numpy array.</span>
<span class="sd">        By default the first image series is returned.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : int, slice, or sequence of page indices</span>
<span class="sd">            Defines which pages to return as array.</span>
<span class="sd">        series : int</span>
<span class="sd">            Defines which series of pages to return as array.</span>
<span class="sd">        memmap : bool</span>
<span class="sd">            If True, use numpy.memmap to read arrays from file if possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">series</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">pages</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;key must be an int, slice, or sequence&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">memmap</span><span class="o">=</span><span class="n">memmap</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nih</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="n">p</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">colormapped</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="n">memmap</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_palette</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">color_map</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">):</span>
                <span class="n">firstpage</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span> <span class="k">if</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">nopage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">firstpage</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">memmap</span><span class="o">=</span><span class="n">memmap</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">memmap</span><span class="o">=</span><span class="n">memmap</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="k">else</span> <span class="n">nopage</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;failed to reshape </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                              <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="n">result</span></div>
    <span class="k">def</span> <span class="nf">_omeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in OME-TIFF file(s).&quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="o">.</span><span class="n">XML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;image_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;UUID&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span> <span class="o">=</span> <span class="p">{</span><span class="n">uuid</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
        <span class="n">modulo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;BinaryOnly&#39;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;not an OME-TIFF master file&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;StructuredAnnotations&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">annot</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Namespace&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;modulo&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">modul</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">along</span> <span class="ow">in</span> <span class="n">modul</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">along</span><span class="o">.</span><span class="n">tag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Along&#39;</span><span class="p">):</span>
                                    <span class="k">continue</span>
                                <span class="n">axis</span> <span class="o">=</span> <span class="n">along</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">newaxis</span> <span class="o">=</span> <span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Type&#39;</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
                                <span class="n">newaxis</span> <span class="o">=</span> <span class="n">AXES_LABELS</span><span class="p">[</span><span class="n">newaxis</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s">&#39;Start&#39;</span> <span class="ow">in</span> <span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                                    <span class="n">labels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;Start&#39;</span><span class="p">]),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;End&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Step&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">along</span>
                                              <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Label&#39;</span><span class="p">)]</span>
                                <span class="n">modulo</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Image&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">pixels</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pixels</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Pixels&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">atr</span> <span class="o">=</span> <span class="n">pixels</span><span class="o">.</span><span class="n">attrib</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">atr</span><span class="p">[</span><span class="s">&#39;DimensionOrder&#39;</span><span class="p">]))</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atr</span><span class="p">[</span><span class="s">&#39;Size&#39;</span><span class="o">+</span><span class="n">ax</span><span class="p">])</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">ifds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;TiffData&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">atr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrib</span>
                    <span class="n">ifd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;IFD&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;NumPlanes&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="s">&#39;IFD&#39;</span> <span class="ow">in</span> <span class="n">atr</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PlaneCount&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;First&#39;</span><span class="o">+</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">uuid</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;UUID&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">uuid</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multifile</span><span class="p">:</span>
                                    <span class="c"># abort reading multi file OME series</span>
                                    <span class="k">return</span> <span class="p">[]</span>
                                <span class="n">fn</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;FileName&#39;</span><span class="p">]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">tf</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;failed to read </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
                                    <span class="k">break</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span>
                            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">text</span><span class="p">]</span><span class="o">.</span><span class="n">pages</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)):</span>
                                    <span class="n">ifds</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">ifd</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;ome-xml: index out of range&quot;</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)):</span>
                                <span class="n">ifds</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">ifd</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;ome-xml: index out of range&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Record</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="n">ifds</span><span class="p">,</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">ifds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="p">(</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="n">modulo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">newaxis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//=</span> <span class="n">size</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">+</span><span class="n">newaxis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of image pages in file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over pages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about file.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
            <span class="n">format_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fsize</span><span class="p">),</span>
            <span class="p">{</span><span class="s">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s">&#39;little endian&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s">&#39;big endian&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bigtiff</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;bigtiff&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%i</span><span class="s"> pages&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%i</span><span class="s"> series&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%i</span><span class="s"> files&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tiffs</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.fstat"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.fstat">[docs]</a>    <span class="k">def</span> <span class="nf">fstat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c"># io.UnsupportedOperation</span>
            <span class="k">return</span> <span class="bp">None</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_bigtiff"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_bigtiff">[docs]</a>    <span class="k">def</span> <span class="nf">is_bigtiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_size</span> <span class="o">!=</span> <span class="mi">4</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_rgb"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_rgb">[docs]</a>    <span class="k">def</span> <span class="nf">is_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_rgb</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_palette"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_palette">[docs]</a>    <span class="k">def</span> <span class="nf">is_palette</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_palette</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_mdgel"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_mdgel">[docs]</a>    <span class="k">def</span> <span class="nf">is_mdgel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_mdgel</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_mediacy"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_mediacy">[docs]</a>    <span class="k">def</span> <span class="nf">is_mediacy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_mediacy</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_stk"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_stk">[docs]</a>    <span class="k">def</span> <span class="nf">is_stk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_stk</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_lsm"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_lsm">[docs]</a>    <span class="k">def</span> <span class="nf">is_lsm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_lsm</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_imagej"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_imagej">[docs]</a>    <span class="k">def</span> <span class="nf">is_imagej</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_imagej</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_micromanager"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_micromanager">[docs]</a>    <span class="k">def</span> <span class="nf">is_micromanager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_micromanager</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_nih"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_nih">[docs]</a>    <span class="k">def</span> <span class="nf">is_nih</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_nih</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_fluoview"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_fluoview">[docs]</a>    <span class="k">def</span> <span class="nf">is_fluoview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_fluoview</span></div>
    <span class="nd">@lazyattr</span>
<div class="viewcode-block" id="TiffFile.is_ome"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffFile.is_ome">[docs]</a>    <span class="k">def</span> <span class="nf">is_ome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_ome</span></div></div>
<span class="k">class</span> <span class="nc">TiffPage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A TIFF image file directory (IFD).</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    index : int</span>
<span class="sd">        Index of page in file.</span>
<span class="sd">    dtype : str {TIFF_SAMPLE_DTYPES}</span>
<span class="sd">        Data type of image, colormapped if applicable.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Dimensions of the image array in TIFF page,</span>
<span class="sd">        colormapped and with one alpha channel if applicable.</span>
<span class="sd">    axes : str</span>
<span class="sd">        Axes label codes:</span>
<span class="sd">        &#39;X&#39; width, &#39;Y&#39; height, &#39;S&#39; sample, &#39;P&#39; plane, &#39;I&#39; image series,</span>
<span class="sd">        &#39;Z&#39; depth, &#39;C&#39; color|em-wavelength|channel, &#39;E&#39; ex-wavelength|lambda,</span>
<span class="sd">        &#39;T&#39; time, &#39;R&#39; region|tile, &#39;A&#39; angle, &#39;F&#39; phase, &#39;H&#39; lifetime,</span>
<span class="sd">        &#39;L&#39; exposure, &#39;V&#39; event, &#39;Q&#39; unknown, &#39;_&#39; missing</span>
<span class="sd">    tags : TiffTags</span>
<span class="sd">        Dictionary of tags in page.</span>
<span class="sd">        Tag values are also directly accessible as attributes.</span>
<span class="sd">    color_map : numpy array</span>
<span class="sd">        Color look up table, if exists.</span>
<span class="sd">    mm_uic_tags: Record(dict)</span>
<span class="sd">        Consolidated MetaMorph mm_uic# tags, if exists.</span>
<span class="sd">    cz_lsm_scan_info: Record(dict)</span>
<span class="sd">        LSM scan info attributes, if exists.</span>
<span class="sd">    imagej_tags: Record(dict)</span>
<span class="sd">        Consolidated ImageJ description and metadata tags, if exists.</span>
<span class="sd">    All attributes are read-only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">TiffTags</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fromfile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_tags</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_fromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read TIFF IFD structure and its tags from file.</span>
<span class="sd">        File cursor must be at storage position of IFD offset and is left at</span>
<span class="sd">        offset to next IFD.</span>
<span class="sd">        Raises StopIteration if offset (first bytes read) is 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_fh</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span>
        <span class="n">offset_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">offset_size</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;Q&#39;</span><span class="p">}[</span><span class="n">offset_size</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">offset_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">offset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
        <span class="c"># read standard tags</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">fmt</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)}[</span><span class="n">offset_size</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">numtags</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;corrupted page list&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
        <span class="n">tagcode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numtags</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tagcode</span> <span class="o">&gt;</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;tags are not ordered by code&quot;</span><span class="p">)</span>
                <span class="n">tagcode</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># some files contain multiple IFD with same code</span>
                    <span class="c"># e.g. MicroManager files contain two image_description</span>
                    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;_1&#39;</span><span class="p">,</span> <span class="s">&#39;_2&#39;</span><span class="p">,</span> <span class="s">&#39;_3&#39;</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">ext</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                            <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
                            <span class="k">break</span>
        <span class="c"># read LSM info subrecords</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">reader</span> <span class="ow">in</span> <span class="n">CZ_LSM_INFO_READERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cz_lsm_info</span><span class="p">[</span><span class="s">&#39;offset_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">offset</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;cz_lsm_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="n">reader</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_process_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate standard tags and initialize attributes.</span>
<span class="sd">        Raise ValueError if tag values are not supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TIFF_TAGS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">or</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                     <span class="n">value</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="n">validate</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">validate</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span>
                            <span class="n">validate</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.value (</span><span class="si">%s</span><span class="s">) not supported&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s">&#39;bits_per_sample&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">v</span><span class="o">-</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s">&#39;sample_format&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_format</span> <span class="o">=</span> <span class="n">TIFF_SAMPLE_FORMATS</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">v</span><span class="o">-</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_format</span> <span class="o">=</span> <span class="p">[</span><span class="n">TIFF_SAMPLE_FORMATS</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_format</span> <span class="o">=</span> <span class="n">TIFF_SAMPLE_FORMATS</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;photometric&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;image_length&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strips_per_image</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_length</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows_per_strip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rows_per_strip</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strips_per_image</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">TIFF_SAMPLE_DTYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_imagej</span><span class="p">:</span>
            <span class="c"># consolidate imagej meta data</span>
            <span class="k">if</span> <span class="s">&#39;image_description_1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>  <span class="c"># MicroManager</span>
                <span class="n">adict</span> <span class="o">=</span> <span class="n">imagej_description</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;image_description_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adict</span> <span class="o">=</span> <span class="n">imagej_description</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;image_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;imagej_metadata&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">adict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">imagej_metadata</span><span class="p">(</span>
                        <span class="n">tags</span><span class="p">[</span><span class="s">&#39;imagej_metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">tags</span><span class="p">[</span><span class="s">&#39;imagej_byte_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagej_tags</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">adict</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;image_length&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;image_width&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="c"># some GEL file pages are missing image data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strip_offsets</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_palette</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;color_map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_map</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dmax</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">color_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="c">#else:</span>
            <span class="c">#    self.dtype = numpy.uint8</span>
            <span class="c">#    self.color_map &gt;&gt;= 8</span>
            <span class="c">#    self.color_map = self.color_map.astype(self.dtype)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
            <span class="c"># consolidate mm_uci tags</span>
            <span class="n">planes</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s">&#39;mm_uic2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_uic_tags</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;mm_uic2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;mm_uic3&#39;</span><span class="p">,</span> <span class="s">&#39;mm_uic4&#39;</span><span class="p">,</span> <span class="s">&#39;mm_uic1&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mm_uic_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planar_configuration</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;PYXS&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;PSYX&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_palette</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;CPYX&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;palette cannot be applied&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_palette</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_palette</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s">&#39;extra_samples&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_samples</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planar_configuration</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;CYX&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;palette cannot be applied&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_palette</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;YX&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rgb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planar_configuration</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;YXS&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;SYX&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rgb</span> <span class="ow">and</span> <span class="s">&#39;extra_samples&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">extra_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_samples</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;extra_samples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">extra_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">extra_samples</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">exs</span> <span class="ow">in</span> <span class="n">extra_samples</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exs</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;unassalpha&#39;</span><span class="p">,</span> <span class="s">&#39;assocalpha&#39;</span><span class="p">,</span> <span class="s">&#39;unspecified&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planar_configuration</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;YX&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;strip_byte_counts&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strip_byte_counts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">colormapped</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rgbonly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">memmap</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from file and return as numpy array.</span>
<span class="sd">        Raise ValueError if format is unsupported.</span>
<span class="sd">        If any argument is False, the shape of the returned array might be</span>
<span class="sd">        different from the page shape.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        squeeze : bool</span>
<span class="sd">            If True, all length-1 dimensions (except X and Y) are</span>
<span class="sd">            squeezed out from result.</span>
<span class="sd">        colormapped : bool</span>
<span class="sd">            If True, color mapping is applied for palette-indexed images.</span>
<span class="sd">        rgbonly : bool</span>
<span class="sd">            If True, return RGB(A) image without additional extra samples.</span>
<span class="sd">        memmap : bool</span>
<span class="sd">            If True, use numpy.memmap to read array if possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_fh</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;TIFF file is not open&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;data type not supported: </span><span class="si">%s%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF_DECOMPESSORS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cannot decompress </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;ycbcr_subsampling&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;ycbcr_subsampling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;YCbCr subsampling not supported&quot;</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;sample_format&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;sample formats don&#39;t match </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">image_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span>
        <span class="n">image_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_length</span>
        <span class="n">typecode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">dtype</span>
        <span class="n">bits_per_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span>
        <span class="n">byteorder_is_native</span> <span class="o">=</span> <span class="p">({</span><span class="s">&#39;big&#39;</span><span class="p">:</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;little&#39;</span><span class="p">:</span> <span class="s">&#39;&lt;&#39;</span><span class="p">}[</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]</span> <span class="o">==</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;tile_offsets&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">byte_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_byte_counts</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_offsets</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">byte_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_byte_counts</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_offsets</span>
            <span class="n">tile_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width</span>
            <span class="n">tile_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_length</span>
            <span class="n">tw</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_width</span> <span class="o">+</span> <span class="n">tile_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile_width</span>
            <span class="n">tl</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_length</span> <span class="o">+</span> <span class="n">tile_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile_length</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">tl</span><span class="o">*</span><span class="n">tile_length</span><span class="p">,</span> <span class="n">tw</span><span class="o">*</span><span class="n">tile_width</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">tile_length</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">runlen</span> <span class="o">=</span> <span class="n">tile_width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">byte_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_byte_counts</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_offsets</span>
            <span class="n">runlen</span> <span class="o">=</span> <span class="n">image_width</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">byte_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte_counts</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">o</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">offsets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;corrupted page&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span>
            <span class="ow">and</span> <span class="n">bits_per_sample</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">byte_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))))):</span>
            <span class="c"># contiguous data</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">memmap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="ow">or</span>
                                <span class="p">(</span><span class="s">&#39;extra_samples&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="ow">or</span>
                                <span class="p">(</span><span class="n">colormapped</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_palette</span><span class="p">)</span> <span class="ow">or</span>
                                <span class="p">(</span><span class="ow">not</span> <span class="n">byteorder_is_native</span><span class="p">))):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy_fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;=&#39;</span> <span class="o">+</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planar_configuration</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
                <span class="n">runlen</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span>
            <span class="k">if</span> <span class="n">bits_per_sample</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bits_per_sample</span> <span class="o">*</span> <span class="n">runlen</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;data and sample size mismatch&quot;</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bits_per_sample</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">unpackrgb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">bits_per_sample</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">unpackints</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">bits_per_sample</span><span class="p">,</span> <span class="n">runlen</span><span class="p">)</span>
            <span class="n">decompress</span> <span class="o">=</span> <span class="n">TIFF_DECOMPESSORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="n">tw</span><span class="p">,</span> <span class="n">tl</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">byte_counts</span><span class="p">):</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">tile</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">decompress</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bytecount</span><span class="p">)))</span>
                    <span class="n">tile</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">tile_shape</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="s">&#39;horizontal&#39;</span><span class="p">:</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tile</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">tl</span><span class="p">:</span><span class="n">tl</span><span class="o">+</span><span class="n">tile_length</span><span class="p">,</span>
                           <span class="n">tw</span><span class="p">:</span><span class="n">tw</span><span class="o">+</span><span class="n">tile_width</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tile</span>
                    <span class="k">del</span> <span class="n">tile</span>
                    <span class="n">tw</span> <span class="o">+=</span> <span class="n">tile_width</span>
                    <span class="k">if</span> <span class="n">tw</span> <span class="o">&gt;=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">tw</span><span class="p">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tl</span> <span class="o">+</span> <span class="n">tile_length</span>
                        <span class="k">if</span> <span class="n">tl</span> <span class="o">&gt;=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="n">tl</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pl</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">image_length</span><span class="p">,</span> <span class="p">:</span><span class="n">image_width</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strip_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows_per_strip</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">*</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_pixel</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">byte_counts</span><span class="p">):</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">strip</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bytecount</span><span class="p">)</span>
                    <span class="n">strip</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">decompress</span><span class="p">(</span><span class="n">strip</span><span class="p">))</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">strip</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">strip_size</span><span class="p">,</span>
                               <span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">index</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">strip</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">strip</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="n">size</span>
        <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="s">&#39;horizontal&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
            <span class="c"># work around bug in LSM510 software</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_lsm</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">):</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colormapped</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_palette</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="n">bits_per_sample</span><span class="p">:</span>
                <span class="c"># FluoView and LSM might fail here</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_map</span><span class="p">,</span>
                                    <span class="n">result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rgbonly</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rgb</span> <span class="ow">and</span> <span class="s">&#39;extra_samples&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="c"># return only RGB and first alpha channel if exists</span>
            <span class="n">extra_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_samples</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;extra_samples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">extra_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">extra_samples</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extra_samples</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">exs</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;unassalpha&#39;</span><span class="p">,</span> <span class="s">&#39;assocalpha&#39;</span><span class="p">,</span> <span class="s">&#39;unspecified&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planar_configuration</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">]]</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planar_configuration</span> <span class="o">==</span> <span class="s">&#39;contig&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;failed to reshape from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about page.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)),</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s"> bit&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bits_per_sample</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="k">if</span> <span class="s">&#39;photometric&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="k">else</span> <span class="s">&#39;raw&#39;</span><span class="p">,</span>
            <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s">&#39;is_stk&#39;</span><span class="p">,</span> <span class="s">&#39;is_lsm&#39;</span><span class="p">,</span> <span class="s">&#39;is_nih&#39;</span><span class="p">,</span> <span class="s">&#39;is_ome&#39;</span><span class="p">,</span> <span class="s">&#39;is_imagej&#39;</span><span class="p">,</span>
                <span class="s">&#39;is_micromanager&#39;</span><span class="p">,</span> <span class="s">&#39;is_fluoview&#39;</span><span class="p">,</span> <span class="s">&#39;is_mdgel&#39;</span><span class="p">,</span> <span class="s">&#39;is_mediacy&#39;</span><span class="p">,</span>
                <span class="s">&#39;is_reduced&#39;</span><span class="p">,</span> <span class="s">&#39;is_tiled&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span> <span class="k">if</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Page </span><span class="si">%i</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return tag value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains a RGB image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;photometric&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;photometric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_palette</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains a palette-colored image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;photometric&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;photometric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_tiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains tiled image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;tile_width&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_reduced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page is a reduced image of another image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;new_subfile_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_mdgel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains md_file_tag tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;md_file_tag&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_mediacy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains Media Cybernetics Id tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;mc_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;mc_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;MC TIFF&#39;</span><span class="p">))</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_stk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains MM_UIC2 tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;mm_uic2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_lsm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains LSM CZ_LSM_INFO tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;cz_lsm_info&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_fluoview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains FluoView MM_STAMP tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;mm_stamp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_nih</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains NIH image header.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;nih_image_header&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_ome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains OME-XML in image_description tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;image_description&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span>
            <span class="s">&#39;image_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&lt;?xml version=&#39;</span><span class="p">))</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_shaped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains shape in image_description tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;image_description&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span>
            <span class="s">&#39;image_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;shape=(&#39;</span><span class="p">))</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_imagej</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains ImageJ description.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;image_description&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;image_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;ImageJ=&#39;</span><span class="p">))</span> <span class="ow">or</span>
            <span class="p">(</span><span class="s">&#39;image_description_1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>  <span class="c"># Micromanager</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;image_description_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;ImageJ=&#39;</span><span class="p">)))</span>
    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_micromanager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if page contains Micro-Manager metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;micromanager_metadata&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
<span class="k">class</span> <span class="nc">TiffTag</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A TIFF tag structure.</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        Attribute name of tag.</span>
<span class="sd">    code : int</span>
<span class="sd">        Decimal code of tag.</span>
<span class="sd">    dtype : str</span>
<span class="sd">        Datatype of tag data. One of TIFF_DATA_TYPES.</span>
<span class="sd">    count : int</span>
<span class="sd">        Number of values.</span>
<span class="sd">    value : various types</span>
<span class="sd">        Tag data as Python object.</span>
<span class="sd">    value_offset : int</span>
<span class="sd">        Location of value in file, if any.</span>
<span class="sd">    All attributes are read-only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;count&#39;</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="s">&#39;value_offset&#39;</span><span class="p">,</span>
                 <span class="s">&#39;_offset&#39;</span><span class="p">,</span> <span class="s">&#39;_value&#39;</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file or arguments.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;_fh&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fromfile</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fromdata</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_fromdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from arguments.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF_DATA_TYPES</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">_fromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read tag structure from open file. Advance file cursor.&quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_fh</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">offset_size</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="n">fmt</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;HHI4s&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;HHQ8s&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)}[</span><span class="n">parent</span><span class="o">.</span><span class="n">offset_size</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">fmt</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">count</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF_TAGS</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF_TAGS</span><span class="p">[</span><span class="n">code</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">CUSTOM_TAGS</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">CUSTOM_TAGS</span><span class="p">[</span><span class="n">code</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF_DATA_TYPES</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;unknown tag data type </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%i%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">parent</span><span class="o">.</span><span class="n">offset_size</span> <span class="ow">or</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">CUSTOM_TAGS</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">tof</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;Q&#39;</span><span class="p">}[</span><span class="n">parent</span><span class="o">.</span><span class="n">offset_size</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="n">tof</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">parent</span><span class="o">.</span><span class="n">_fsize</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;corrupt file - invalid tag value offset&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;corrupt value offset for tag </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">CUSTOM_TAGS</span><span class="p">:</span>
                <span class="n">readfunc</span> <span class="o">=</span> <span class="n">CUSTOM_TAGS</span><span class="p">[</span><span class="n">code</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">readfunc</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c"># bug in numpy/Python 3.x ?</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c"># numpy.core.records.record</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF_TAGS</span> <span class="ow">or</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">read_numpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c"># bug in numpy/Python 3.x ?</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">value</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">CUSTOM_TAGS</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">stripnull</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__slots__</span><span class="p">)</span>
<div class="viewcode-block" id="TiffSequence"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffSequence">[docs]</a><span class="k">class</span> <span class="nc">TiffSequence</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequence of image files.</span>
<span class="sd">    Properties</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list</span>
<span class="sd">        List of file names.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Shape of image sequence.</span>
<span class="sd">    axes : str</span>
<span class="sd">        Labels of axes in shape.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; ims = TiffSequence(&quot;test.oif.files/*.tif&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ims = ims.asarray()</span>
<span class="sd">    &gt;&gt;&gt; ims.shape</span>
<span class="sd">    (2, 100, 256, 256)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_axes_pattern</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        # matches Olympus OIF and Leica TIFF series</span>
<span class="s">        _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))</span>
<span class="s">        _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s">        _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s">        _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s">        _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s">        _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s">        _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s">        &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">_ParseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">imread</span><span class="o">=</span><span class="n">TiffFile</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s">&#39;axes&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from multiple files.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : str, or sequence of str</span>
<span class="sd">            Glob pattern or sequence of file names.</span>
<span class="sd">        imread : function or class</span>
<span class="sd">            Image read function or class with asarray function returning numpy</span>
<span class="sd">            array from single file.</span>
<span class="sd">        pattern : str</span>
<span class="sd">            Regular expression pattern that matches axes names and sequence</span>
<span class="sd">            indices in file names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">natural_sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;no files found&quot;</span><span class="p">)</span>
        <span class="c">#if not os.path.isfile(files[0]):</span>
        <span class="c">#    raise ValueError(&quot;file not found&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">imread</span><span class="p">,</span> <span class="s">&#39;asarray&#39;</span><span class="p">):</span>
            <span class="n">_imread</span> <span class="o">=</span> <span class="n">imread</span>
            <span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">_imread</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">im</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imread</span> <span class="o">=</span> <span class="n">imread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_pattern</span> <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s">&#39;axes&#39;</span> <span class="k">else</span> <span class="n">pattern</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;I&#39;</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;I&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_index</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about image sequence.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s">&#39;* files: </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">),</span>
            <span class="s">&#39;* axes: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
            <span class="s">&#39;* shape: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="viewcode-block" id="TiffSequence.close"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffSequence.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>
<div class="viewcode-block" id="TiffSequence.asarray"><a class="viewcode-back" href="../tifffile.html#tifffile.TiffSequence.asarray">[docs]</a>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from all files and return as single numpy array.</span>
<span class="sd">        Raise IndexError if image shapes don&#39;t match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">result_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">result_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_index</span><span class="p">)]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
        <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">result_shape</span>
        <span class="k">return</span> <span class="n">result</span></div>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get axes and shape from file names.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseError</span><span class="p">(</span><span class="s">&quot;invalid pattern&quot;</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseError</span><span class="p">(</span><span class="s">&quot;pattern doesn&#39;t match file names&quot;</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseError</span><span class="p">(</span><span class="s">&quot;pattern doesn&#39;t match axis name and index&quot;</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseError</span><span class="p">(</span><span class="s">&quot;pattern doesn&#39;t match file names&quot;</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">axes</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;axes don&#39;t match within the image sequence&quot;</span><span class="p">)</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">])</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">start_index</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;files are missing. Missing data are zeroed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_index</span> <span class="o">=</span> <span class="n">start_index</span></div>
<span class="k">class</span> <span class="nc">Record</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dictionary with attribute access.</span>
<span class="sd">    Can also be initialized with numpy.core.records.record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">dict</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">!=</span> <span class="s">&#39;S&#39;</span> <span class="k">else</span> <span class="n">stripnull</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pretty print Record.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>  <span class="c"># does not work with byte</span>
                <span class="k">continue</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Record</span><span class="p">):</span>
                    <span class="n">lists</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TiffPage</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&quot;* </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">[:</span><span class="n">PRINT_LINE_LEN</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;* </span><span class="si">%s</span><span class="s">[</span><span class="si">%i</span><span class="s">]</span><span class="se">\n</span><span class="s">  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                             <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">  &quot;</span><span class="p">)))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TiffTags</span><span class="p">(</span><span class="n">Record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dictionary of TiffTags with attribute access.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about all tags.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">code</span><span class="p">):</span>
            <span class="n">typecode</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%i%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">tag</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;* </span><span class="si">%i</span><span class="s"> </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="n">PRINT_LINE_LEN</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as byte string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy_fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">+</span><span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">read_numpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as numpy array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy_fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">+</span><span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as object.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)),</span> <span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">read_mm_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MM_HEADER tag from file and return as numpy.rec.array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">MM_HEADER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">read_mm_stamp</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MM_STAMP tag from file and return as numpy.array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy_fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;8f8&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">read_mm_uic1</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MM_UIC1 tag from file and return as dictionary.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%i</span><span class="s">I&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">count</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">MM_TAG_IDS</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MM_TAG_IDS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_mm_uic2</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MM_UIC2 tag from file and return as dictionary.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;number_planes&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">}</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">numpy_fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">count</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;z_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">6</span><span class="p">]</span> <span class="o">//</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">6</span><span class="p">]</span>
    <span class="c">#result[&#39;date_created&#39;] = tuple(values[2::6])</span>
    <span class="c">#result[&#39;time_created&#39;] = tuple(values[3::6])</span>
    <span class="c">#result[&#39;date_modified&#39;] = tuple(values[4::6])</span>
    <span class="c">#result[&#39;time_modified&#39;] = tuple(values[5::6])</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="k">def</span> <span class="nf">read_mm_uic3</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MM_UIC3 tag from file and return as dictionary.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">numpy_fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">count</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;wavelengths&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]}</span>
<span class="k">def</span> <span class="nf">read_mm_uic4</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MM_UIC4 tag from file and return as dictionary.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s">&#39;hI&#39;</span><span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">count</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">MM_TAG_IDS</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MM_TAG_IDS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_cz_lsm_info</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read CS_LSM_INFO tag from file and return as numpy.rec.array.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">CZ_LSM_INFO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">{</span><span class="mi">50350412</span><span class="p">:</span> <span class="s">&#39;1.3&#39;</span><span class="p">,</span> <span class="mi">67127628</span><span class="p">:</span> <span class="s">&#39;2.0&#39;</span><span class="p">}[</span><span class="n">result</span><span class="o">.</span><span class="n">magic_number</span><span class="p">]</span>  <span class="c"># validation</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="k">def</span> <span class="nf">read_cz_lsm_time_stamps</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM time stamps from file and return as list.&quot;&quot;&quot;</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">count</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;lsm_time_stamps block is too short&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%s%d</span><span class="s">d&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span><span class="p">)),</span>
                         <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">read_cz_lsm_event_list</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM events from file and return as list of (time, type, text).&quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">esize</span><span class="p">,</span> <span class="n">etime</span><span class="p">,</span> <span class="n">etype</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;IdI&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">etext</span> <span class="o">=</span> <span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">esize</span> <span class="o">-</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">etime</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">etext</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">events</span>
<span class="k">def</span> <span class="nf">read_cz_lsm_scan_info</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM scan information from file and return as Record.&quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">Record</span><span class="p">()</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="p">]</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="k">if</span> <span class="mh">0x10000000</span> <span class="o">!=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a lsm_scan_info structure&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">entry</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&quot;III&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">CZ_LSM_SCAN_INFO_ARRAYS</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">CZ_LSM_SCAN_INFO_ARRAYS</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
            <span class="n">newobj</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">newobj</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">newobj</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">CZ_LSM_SCAN_INFO_STRUCTS</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">newobj</span> <span class="o">=</span> <span class="n">Record</span><span class="p">()</span>
            <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newobj</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">newobj</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">CZ_LSM_SCAN_INFO_ATTRIBUTES</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">CZ_LSM_SCAN_INFO_ATTRIBUTES</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">:</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="s">&quot;unknown_</span><span class="si">%x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">entry</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">block</span>
<span class="k">def</span> <span class="nf">read_nih_image_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read NIH_IMAGE_HEADER tag from file and return as numpy.rec.array.&quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">NIH_IMAGE_HEADER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">xunit</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">xunit</span><span class="p">[:</span><span class="n">a</span><span class="o">.</span><span class="n">_xunit_len</span><span class="p">]</span>
    <span class="n">a</span><span class="o">.</span><span class="n">um</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">um</span><span class="p">[:</span><span class="n">a</span><span class="o">.</span><span class="n">_um_len</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a</span>
<span class="k">def</span> <span class="nf">imagej_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return dict from ImageJ meta data tag value.&quot;&quot;&quot;</span>
    <span class="n">_str</span> <span class="o">=</span> <span class="nb">str</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;cp1252&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">read_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">def</span> <span class="nf">read_double</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;d&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)),</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">read_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="c">#return struct.unpack(&#39;b&#39; * len(data), data)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">metadata_types</span> <span class="o">=</span> <span class="p">{</span>  <span class="c"># big endian</span>
        <span class="n">b</span><span class="s">&#39;info&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="n">read_string</span><span class="p">),</span>
        <span class="n">b</span><span class="s">&#39;labl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;labels&#39;</span><span class="p">,</span> <span class="n">read_string</span><span class="p">),</span>
        <span class="n">b</span><span class="s">&#39;rang&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;ranges&#39;</span><span class="p">,</span> <span class="n">read_double</span><span class="p">),</span>
        <span class="n">b</span><span class="s">&#39;luts&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;luts&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
        <span class="n">b</span><span class="s">&#39;roi &#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;roi&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
        <span class="n">b</span><span class="s">&#39;over&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;overlays&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">)}</span>
    <span class="n">metadata_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>  <span class="c"># little endian</span>
        <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata_types</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bytecounts</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;no ImageJ meta data&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;IJIJ&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;JIJI&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid ImageJ meta data&quot;</span><span class="p">)</span>
    <span class="n">header_size</span> <span class="o">=</span> <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">header_size</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">header_size</span> <span class="o">&gt;</span> <span class="mi">804</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid ImageJ meta data header size&quot;</span><span class="p">)</span>
    <span class="n">ntypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">header_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s">&#39;4sI&#39;</span><span class="o">*</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">ntypes</span><span class="o">*</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ntypes</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">metadata_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mtype</span><span class="p">,</span> <span class="p">(</span><span class="n">_str</span><span class="p">(</span><span class="n">mtype</span><span class="p">),</span> <span class="n">read_bytes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pos1</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos1</span><span class="p">],</span> <span class="n">byteorder</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos1</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">values</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="k">def</span> <span class="nf">imagej_description</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return dict from ImageJ image_description tag.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_bool</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">b</span><span class="s">&#39;true&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;false&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}[</span><span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="n">_str</span> <span class="o">=</span> <span class="nb">str</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;cp1252&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">_bool</span><span class="p">,</span> <span class="n">_str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">result</span><span class="p">[</span><span class="n">_str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="k">def</span> <span class="nf">read_micromanager_metadata</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MicroManager non-TIFF settings from open file and return as dict.</span>
<span class="sd">    The settings can be used to read image data without parsing the TIFF file.</span>
<span class="sd">    Raise ValueError if file does not contain valid MicroManager metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="s">&#39;II&#39;</span><span class="p">:</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;MM&#39;</span><span class="p">:</span> <span class="s">&#39;&gt;&#39;</span><span class="p">}[</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a MicroManager TIFF file&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">(</span><span class="n">index_header</span><span class="p">,</span> <span class="n">index_offset</span><span class="p">,</span> <span class="n">display_header</span><span class="p">,</span> <span class="n">display_offset</span><span class="p">,</span>
     <span class="n">comments_header</span><span class="p">,</span> <span class="n">comments_offset</span><span class="p">,</span> <span class="n">summary_header</span><span class="p">,</span> <span class="n">summary_length</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s">&quot;IIIIIIII&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">summary_header</span> <span class="o">!=</span> <span class="mi">2355492</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid MicroManager summary_header&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">summary_length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index_header</span> <span class="o">!=</span> <span class="mi">54773648</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid MicroManager index_header&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">index_offset</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s">&quot;II&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="mi">3453623</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid MicroManager index_header&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s">&quot;IIIII&quot;</span><span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">count</span><span class="p">))</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;index_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;channel&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="s">&#39;slice&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span> <span class="s">&#39;frame&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
        <span class="s">&#39;position&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span> <span class="s">&#39;offset&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">::</span><span class="mi">5</span><span class="p">]}</span>
    <span class="k">if</span> <span class="n">display_header</span> <span class="o">!=</span> <span class="mi">483765892</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid MicroManager display_header&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">display_offset</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s">&quot;II&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="mi">347834724</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid MicroManager display_header&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;display_settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comments_header</span> <span class="o">!=</span> <span class="mi">99384722</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid MicroManager comments_header&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">comments_offset</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s">&quot;II&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="mi">84720485</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid MicroManager comments_header&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>
<span class="k">def</span> <span class="nf">_replace_by</span><span class="p">(</span><span class="n">module_function</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try replace decorated function by module.function.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Could not import module importlib&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">func</span><span class="p">:</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">module_function</span><span class="o">=</span><span class="n">module_function</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">module_function</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">package</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">module</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">oldfunc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">func</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s">&#39;__old_&#39;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldfunc</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;failed to import </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">module_function</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
<span class="nd">@_replace_by</span><span class="p">(</span><span class="s">&#39;_tifffile.decodepackbits&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">decodepackbits</span><span class="p">(</span><span class="n">encoded</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress PackBits encoded byte string.</span>
<span class="sd">    PackBits is a simple byte-oriented run-length compression scheme.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func</span> <span class="o">=</span> <span class="nb">ord</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;2&#39;</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result_extend</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">extend</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">129</span><span class="p">:</span>
                <span class="n">result_extend</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">129</span><span class="p">:</span>
                <span class="n">result_extend</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">258</span><span class="o">-</span><span class="n">n</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;2&#39;</span> <span class="k">else</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="nd">@_replace_by</span><span class="p">(</span><span class="s">&#39;_tifffile.decodelzw&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">decodelzw</span><span class="p">(</span><span class="n">encoded</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress LZW (Lempel-Ziv-Welch) encoded TIFF strip (byte string).</span>
<span class="sd">    The strip must begin with a CLEAR code and end with an EOI code.</span>
<span class="sd">    This is an implementation of the LZW decoding algorithm described in (1).</span>
<span class="sd">    It is not compatible with old style LZW compressed files like quad-lzw.tif.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">len_encoded</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
    <span class="n">bitcount_max</span> <span class="o">=</span> <span class="n">len_encoded</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;2&#39;</span><span class="p">:</span>
        <span class="n">newtable</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newtable</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">([</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
    <span class="n">newtable</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">next_code</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Return integer of `bitw` bits at `bitcount` position in encoded.&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bitcount</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">code</span> <span class="o">&lt;&lt;=</span> <span class="n">bitcount</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="n">code</span> <span class="o">&amp;=</span> <span class="n">mask</span>
        <span class="k">return</span> <span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="n">shr</span>
    <span class="n">switchbitch</span> <span class="o">=</span> <span class="p">{</span>  <span class="c"># code: bit-width, shr-bits, bit-mask</span>
        <span class="mi">255</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="s">&#39;1&#39;</span><span class="o">+</span><span class="s">&#39;0&#39;</span><span class="o">*</span><span class="mi">23</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="mi">511</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="s">&#39;1&#39;</span><span class="o">+</span><span class="s">&#39;0&#39;</span><span class="o">*</span><span class="mi">22</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="mi">1023</span><span class="p">:</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="s">&#39;1&#39;</span><span class="o">+</span><span class="s">&#39;0&#39;</span><span class="o">*</span><span class="mi">21</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="mi">2047</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="s">&#39;1&#39;</span><span class="o">+</span><span class="s">&#39;0&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="p">}</span>
    <span class="n">bitw</span><span class="p">,</span> <span class="n">shr</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">switchbitch</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span>
    <span class="n">bitcount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">len_encoded</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;strip must be at least 4 characters long&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">next_code</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;strip must begin with CLEAR code&quot;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">oldcode</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result_append</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">next_code</span><span class="p">()</span>  <span class="c"># ~5% faster when inlining this function</span>
        <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">bitw</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">257</span> <span class="ow">or</span> <span class="n">bitcount</span> <span class="o">&gt;=</span> <span class="n">bitcount_max</span><span class="p">:</span>  <span class="c"># EOI</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">256</span><span class="p">:</span>  <span class="c"># CLEAR</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">newtable</span><span class="p">[:]</span>
            <span class="n">table_append</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">append</span>
            <span class="n">lentable</span> <span class="o">=</span> <span class="mi">258</span>
            <span class="n">bitw</span><span class="p">,</span> <span class="n">shr</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">switchbitch</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">next_code</span><span class="p">()</span>
            <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">bitw</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">257</span><span class="p">:</span>  <span class="c"># EOI</span>
                <span class="k">break</span>
            <span class="n">result_append</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">code</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="n">lentable</span><span class="p">:</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
                <span class="n">newcode</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">oldcode</span><span class="p">]</span> <span class="o">+</span> <span class="n">decoded</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newcode</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">oldcode</span><span class="p">]</span>
                <span class="n">newcode</span> <span class="o">+=</span> <span class="n">newcode</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">newcode</span>
            <span class="n">result_append</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
            <span class="n">table_append</span><span class="p">(</span><span class="n">newcode</span><span class="p">)</span>
            <span class="n">lentable</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">oldcode</span> <span class="o">=</span> <span class="n">code</span>
        <span class="k">if</span> <span class="n">lentable</span> <span class="ow">in</span> <span class="n">switchbitch</span><span class="p">:</span>
            <span class="n">bitw</span><span class="p">,</span> <span class="n">shr</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">switchbitch</span><span class="p">[</span><span class="n">lentable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="mi">257</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s">&quot;decodelzw encountered unexpected end of stream (code </span><span class="si">%i</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="nd">@_replace_by</span><span class="p">(</span><span class="s">&#39;_tifffile.unpackints&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unpackints</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">itemsize</span><span class="p">,</span> <span class="n">runlen</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress byte string to array of integers of any bit size &lt;= 32.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : byte str</span>
<span class="sd">        Data to decompress.</span>
<span class="sd">    dtype : numpy.dtype or str</span>
<span class="sd">        A numpy boolean or integer type.</span>
<span class="sd">    itemsize : int</span>
<span class="sd">        Number of bits per integer.</span>
<span class="sd">    runlen : int</span>
<span class="sd">        Number of consecutive integers, after which to start at next byte.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">itemsize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c"># bitarray</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;|B&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runlen</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">runlen</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">runlen</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">runlen</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">itemsize</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">itemsize</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">itemsize</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;itemsize out of range: </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">itemsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&quot;biu&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid dtype&quot;</span><span class="p">)</span>
    <span class="n">itembytes</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">itemsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">itembytes</span> <span class="o">!=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;dtype.itemsize too small&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">runlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">runlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">itembytes</span>
    <span class="n">skipbits</span> <span class="o">=</span> <span class="n">runlen</span><span class="o">*</span><span class="n">itemsize</span> <span class="o">%</span> <span class="mi">8</span>
    <span class="k">if</span> <span class="n">skipbits</span><span class="p">:</span>
        <span class="n">skipbits</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">skipbits</span>
    <span class="n">shrbits</span> <span class="o">=</span> <span class="n">itembytes</span><span class="o">*</span><span class="mi">8</span> <span class="o">-</span> <span class="n">itemsize</span>
    <span class="n">bitmask</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">itemsize</span><span class="o">*</span><span class="s">&#39;1&#39;</span><span class="o">+</span><span class="s">&#39;0&#39;</span><span class="o">*</span><span class="n">shrbits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dtypestr</span> <span class="o">=</span> <span class="s">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span>  <span class="c"># dtype always big endian?</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">runlen</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span> <span class="o">//</span> <span class="p">(</span><span class="n">runlen</span><span class="o">*</span><span class="n">itemsize</span> <span class="o">+</span> <span class="n">skipbits</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">bitcount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bitcount</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">itembytes</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">dtypestr</span><span class="p">,</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">dtypestr</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">itembytes</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">code</span> <span class="o">&lt;&lt;=</span> <span class="n">bitcount</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="n">code</span> <span class="o">&amp;=</span> <span class="n">bitmask</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="n">shrbits</span>
        <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">itemsize</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">runlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">skipbits</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="k">def</span> <span class="nf">unpackrgb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="n">bitspersample</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">rescale</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return array from byte string containing packed samples.</span>
<span class="sd">    Use to unpack RGB565 or RGB555 to RGB888 format.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : byte str</span>
<span class="sd">        The data to be decoded. Samples in each pixel are stored consecutively.</span>
<span class="sd">        Pixels are aligned to 8, 16, or 32 bit boundaries.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        The sample data type. The byteorder applies also to the data stream.</span>
<span class="sd">    bitspersample : tuple</span>
<span class="sd">        Number of bits for each sample in a pixel.</span>
<span class="sd">    rescale : bool</span>
<span class="sd">        Upscale samples to the number of bits in dtype.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : ndarray</span>
<span class="sd">        Flattened array of unpacked samples of native dtype.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; data = struct.pack(&#39;BBBB&#39;, 0x21, 0x08, 0xff, 0xff)</span>
<span class="sd">    &gt;&gt;&gt; print(unpackrgb(data, &#39;&lt;B&#39;, (5, 6, 5), False))</span>
<span class="sd">    [ 1  1  1 31 63 31]</span>
<span class="sd">    &gt;&gt;&gt; print(unpackrgb(data, &#39;&lt;B&#39;, (5, 6, 5)))</span>
<span class="sd">    [  8   4   8 255 255 255]</span>
<span class="sd">    &gt;&gt;&gt; print(unpackrgb(data, &#39;&lt;B&#39;, (5, 5, 5)))</span>
<span class="sd">    [ 16   8   8 255 255 255]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="o">*</span><span class="mi">8</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bitspersample</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;sample size not supported </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">))</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s">&#39;BHI&#39;</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="o">*</span><span class="mi">8</span> <span class="o">&gt;=</span> <span class="n">bits</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="n">t</span> <span class="o">&amp;=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;0b&#39;</span><span class="o">+</span><span class="s">&#39;1&#39;</span><span class="o">*</span><span class="n">bps</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="p">((</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">//</span> <span class="n">bps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bps</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">o</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">bps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">//=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">o</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reorient</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return reoriented view of image array.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy array</span>
<span class="sd">        Non-squeezed output of asarray() functions.</span>
<span class="sd">        Axes -3 and -2 must be image length and width respectively.</span>
<span class="sd">    orientation : int or str</span>
<span class="sd">        One of TIFF_ORIENTATIONS keys or values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">TIFF_ORIENTATIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">orientation</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;top_left&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;top_right&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;bottom_left&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;bottom_right&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;left_top&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;right_top&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;left_bottom&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;right_bottom&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="k">def</span> <span class="nf">numpy_fromfile</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return array from data in binary file.</span>
<span class="sd">    Work around numpy issue #2230, &quot;numpy.fromfile does not accept StringIO</span>
<span class="sd">    object&quot; https://github.com/numpy/numpy/issues/2230.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stripnull</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string truncated at first null character.&quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">string</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">format_size</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return file size as string from byte size.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;KB&#39;</span><span class="p">,</span> <span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="s">&#39;GB&#39;</span><span class="p">,</span> <span class="s">&#39;TB&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;%.f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">/=</span> <span class="mf">1024.0</span>
<span class="k">def</span> <span class="nf">natural_sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return human sorted list of strings.</span>
<span class="sd">    &gt;&gt;&gt; natural_sorted([&#39;f1&#39;, &#39;f2&#39;, &#39;f10&#39;])</span>
<span class="sd">    [&#39;f1&#39;, &#39;f2&#39;, &#39;f10&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">sortkey</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;(\d+)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sortkey</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">datetime_from_timestamp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="mi">693594</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Return datetime object from timestamp in Excel serial format.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; datetime_from_timestamp(40237.029999999795)</span>
<span class="sd">    datetime.datetime(2010, 2, 28, 0, 43, 11, 999982)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_tifffile</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s">&#39;testimages&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read all images in directory. Print error message on failure.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; test_tifffile(verbose=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">successful</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s">&#39;*.*&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tif</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">multifile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;ERROR:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">tif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;ERROR:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">tif</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">successful</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%.0f</span><span class="s"> ms&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">tif</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">tif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span><span class="p">,</span>
                <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Successfully read </span><span class="si">%i</span><span class="s"> of </span><span class="si">%i</span><span class="s"> files in </span><span class="si">%.3f</span><span class="s"> s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">successful</span><span class="p">,</span> <span class="n">successful</span><span class="o">+</span><span class="n">failed</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">TIFF_SUBFILE_TYPES</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;reduced_image&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;mask&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">TIFF_PHOTOMETRICS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;miniswhite&#39;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;minisblack&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;rgb&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;palette&#39;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;mask&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;separated&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;cielab&#39;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;icclab&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;itulab&#39;</span><span class="p">,</span>
    <span class="mi">32844</span><span class="p">:</span> <span class="s">&#39;logl&#39;</span><span class="p">,</span>
    <span class="mi">32845</span><span class="p">:</span> <span class="s">&#39;logluv&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">TIFF_COMPESSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;ccittrle&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;ccittfax3&#39;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;ccittfax4&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;lzw&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;ojpeg&#39;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;jpeg&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;adobe_deflate&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s">&#39;t85&#39;</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s">&#39;t43&#39;</span><span class="p">,</span>
    <span class="mi">32766</span><span class="p">:</span> <span class="s">&#39;next&#39;</span><span class="p">,</span>
    <span class="mi">32771</span><span class="p">:</span> <span class="s">&#39;ccittrlew&#39;</span><span class="p">,</span>
    <span class="mi">32773</span><span class="p">:</span> <span class="s">&#39;packbits&#39;</span><span class="p">,</span>
    <span class="mi">32809</span><span class="p">:</span> <span class="s">&#39;thunderscan&#39;</span><span class="p">,</span>
    <span class="mi">32895</span><span class="p">:</span> <span class="s">&#39;it8ctpad&#39;</span><span class="p">,</span>
    <span class="mi">32896</span><span class="p">:</span> <span class="s">&#39;it8lw&#39;</span><span class="p">,</span>
    <span class="mi">32897</span><span class="p">:</span> <span class="s">&#39;it8mp&#39;</span><span class="p">,</span>
    <span class="mi">32898</span><span class="p">:</span> <span class="s">&#39;it8bl&#39;</span><span class="p">,</span>
    <span class="mi">32908</span><span class="p">:</span> <span class="s">&#39;pixarfilm&#39;</span><span class="p">,</span>
    <span class="mi">32909</span><span class="p">:</span> <span class="s">&#39;pixarlog&#39;</span><span class="p">,</span>
    <span class="mi">32946</span><span class="p">:</span> <span class="s">&#39;deflate&#39;</span><span class="p">,</span>
    <span class="mi">32947</span><span class="p">:</span> <span class="s">&#39;dcs&#39;</span><span class="p">,</span>
    <span class="mi">34661</span><span class="p">:</span> <span class="s">&#39;jbig&#39;</span><span class="p">,</span>
    <span class="mi">34676</span><span class="p">:</span> <span class="s">&#39;sgilog&#39;</span><span class="p">,</span>
    <span class="mi">34677</span><span class="p">:</span> <span class="s">&#39;sgilog24&#39;</span><span class="p">,</span>
    <span class="mi">34712</span><span class="p">:</span> <span class="s">&#39;jp2000&#39;</span><span class="p">,</span>
    <span class="mi">34713</span><span class="p">:</span> <span class="s">&#39;nef&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">TIFF_DECOMPESSORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="bp">None</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
    <span class="s">&#39;adobe_deflate&#39;</span><span class="p">:</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">,</span>
    <span class="s">&#39;deflate&#39;</span><span class="p">:</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">,</span>
    <span class="s">&#39;packbits&#39;</span><span class="p">:</span> <span class="n">decodepackbits</span><span class="p">,</span>
    <span class="s">&#39;lzw&#39;</span><span class="p">:</span> <span class="n">decodelzw</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">TIFF_DATA_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;1B&#39;</span><span class="p">,</span>   <span class="c"># BYTE 8-bit unsigned integer.</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;1s&#39;</span><span class="p">,</span>   <span class="c"># ASCII 8-bit byte that contains a 7-bit ASCII code;</span>
               <span class="c">#   the last byte must be NULL (binary zero).</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;1H&#39;</span><span class="p">,</span>   <span class="c"># SHORT 16-bit (2-byte) unsigned integer</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;1I&#39;</span><span class="p">,</span>   <span class="c"># LONG 32-bit (4-byte) unsigned integer.</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;2I&#39;</span><span class="p">,</span>   <span class="c"># RATIONAL Two LONGs: the first represents the numerator of</span>
               <span class="c">#   a fraction; the second, the denominator.</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;1b&#39;</span><span class="p">,</span>   <span class="c"># SBYTE An 8-bit signed (twos-complement) integer.</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;1B&#39;</span><span class="p">,</span>   <span class="c"># UNDEFINED An 8-bit byte that may contain anything,</span>
               <span class="c">#   depending on the definition of the field.</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;1h&#39;</span><span class="p">,</span>   <span class="c"># SSHORT A 16-bit (2-byte) signed (twos-complement) integer.</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s">&#39;1i&#39;</span><span class="p">,</span>   <span class="c"># SLONG A 32-bit (4-byte) signed (twos-complement) integer.</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s">&#39;2i&#39;</span><span class="p">,</span>  <span class="c"># SRATIONAL Two SLONGs: the first represents the numerator</span>
               <span class="c">#   of a fraction, the second the denominator.</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s">&#39;1f&#39;</span><span class="p">,</span>  <span class="c"># FLOAT Single precision (4-byte) IEEE format.</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s">&#39;1d&#39;</span><span class="p">,</span>  <span class="c"># DOUBLE Double precision (8-byte) IEEE format.</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s">&#39;1I&#39;</span><span class="p">,</span>  <span class="c"># IFD unsigned 4 byte IFD offset.</span>
    <span class="c">#14: &#39;&#39;,   # UNICODE</span>
    <span class="c">#15: &#39;&#39;,   # COMPLEX</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s">&#39;1Q&#39;</span><span class="p">,</span>  <span class="c"># LONG8 unsigned 8 byte integer (BigTiff)</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s">&#39;1q&#39;</span><span class="p">,</span>  <span class="c"># SLONG8 signed 8 byte integer (BigTiff)</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s">&#39;1Q&#39;</span><span class="p">,</span>  <span class="c"># IFD8 unsigned 8 byte IFD offset (BigTiff)</span>
<span class="p">}</span>
<span class="n">TIFF_SAMPLE_FORMATS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;uint&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;int&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;float&#39;</span><span class="p">,</span>
    <span class="c">#4: &#39;void&#39;,</span>
    <span class="c">#5: &#39;complex_int&#39;,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;complex&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">TIFF_SAMPLE_DTYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s">&#39;?&#39;</span><span class="p">,</span>  <span class="c"># bitmap</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s">&#39;H&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">18</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">19</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">23</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">26</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">28</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">29</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s">&#39;I&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s">&#39;Q&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s">&#39;b&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s">&#39;h&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s">&#39;i&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s">&#39;q&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s">&#39;e&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s">&#39;f&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s">&#39;d&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;complex&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s">&#39;F&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;complex&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span> <span class="s">&#39;D&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;uint&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span> <span class="s">&#39;B&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">TIFF_ORIENTATIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;top_left&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;top_right&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;bottom_right&#39;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;bottom_left&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;left_top&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;right_top&#39;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;right_bottom&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;left_bottom&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">AXES_LABELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="s">&#39;width&#39;</span><span class="p">,</span>
    <span class="s">&#39;Y&#39;</span><span class="p">:</span> <span class="s">&#39;height&#39;</span><span class="p">,</span>
    <span class="s">&#39;Z&#39;</span><span class="p">:</span> <span class="s">&#39;depth&#39;</span><span class="p">,</span>
    <span class="s">&#39;S&#39;</span><span class="p">:</span> <span class="s">&#39;sample&#39;</span><span class="p">,</span>  <span class="c"># rgb(a)</span>
    <span class="s">&#39;P&#39;</span><span class="p">:</span> <span class="s">&#39;plane&#39;</span><span class="p">,</span>  <span class="c"># page</span>
    <span class="s">&#39;T&#39;</span><span class="p">:</span> <span class="s">&#39;time&#39;</span><span class="p">,</span>
    <span class="s">&#39;C&#39;</span><span class="p">:</span> <span class="s">&#39;channel&#39;</span><span class="p">,</span>  <span class="c"># color, emission wavelength</span>
    <span class="s">&#39;A&#39;</span><span class="p">:</span> <span class="s">&#39;angle&#39;</span><span class="p">,</span>
    <span class="s">&#39;F&#39;</span><span class="p">:</span> <span class="s">&#39;phase&#39;</span><span class="p">,</span>
    <span class="s">&#39;R&#39;</span><span class="p">:</span> <span class="s">&#39;tile&#39;</span><span class="p">,</span>  <span class="c"># region, point</span>
    <span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="s">&#39;lifetime&#39;</span><span class="p">,</span>  <span class="c"># histogram</span>
    <span class="s">&#39;E&#39;</span><span class="p">:</span> <span class="s">&#39;lambda&#39;</span><span class="p">,</span>  <span class="c"># excitation wavelength</span>
    <span class="s">&#39;L&#39;</span><span class="p">:</span> <span class="s">&#39;exposure&#39;</span><span class="p">,</span>  <span class="c"># lux</span>
    <span class="s">&#39;V&#39;</span><span class="p">:</span> <span class="s">&#39;event&#39;</span><span class="p">,</span>
    <span class="s">&#39;Q&#39;</span><span class="p">:</span> <span class="s">&#39;other&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">AXES_LABELS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">AXES_LABELS</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<span class="c"># NIH Image PicHeader v1.63</span>
<span class="n">NIH_IMAGE_HEADER</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">&#39;fileid&#39;</span><span class="p">,</span> <span class="s">&#39;a8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;nlines&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;pixelsperline&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;oldlutmode&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;oldncolors&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;colors&#39;</span><span class="p">,</span> <span class="s">&#39;u1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;oldcolorstart&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;colorwidth&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;extracolors&#39;</span><span class="p">,</span> <span class="s">&#39;u2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;nextracolors&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;foregroundindex&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;backgroundindex&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;xscale&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;_x0&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;_x1&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;units_t&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;p1&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="s">&#39;p2&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="s">&#39;curvefit_t&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;ncoefficients&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;coeff&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;_um_len&#39;</span><span class="p">,</span> <span class="s">&#39;u1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;um&#39;</span><span class="p">,</span> <span class="s">&#39;a15&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;_x2&#39;</span><span class="p">,</span> <span class="s">&#39;u1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;binarypic&#39;</span><span class="p">,</span> <span class="s">&#39;b1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;slicestart&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;sliceend&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;scalemagnification&#39;</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;nslices&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;slicespacing&#39;</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;currentslice&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;frameinterval&#39;</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;pixelaspectratio&#39;</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;colorstart&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;colorend&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;ncolors&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;fill1&#39;</span><span class="p">,</span> <span class="s">&#39;3u2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;fill2&#39;</span><span class="p">,</span> <span class="s">&#39;3u2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;colortable_t&#39;</span><span class="p">,</span> <span class="s">&#39;u1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;lutmode_t&#39;</span><span class="p">,</span> <span class="s">&#39;u1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;invertedtable&#39;</span><span class="p">,</span> <span class="s">&#39;b1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;zeroclip&#39;</span><span class="p">,</span> <span class="s">&#39;b1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;_xunit_len&#39;</span><span class="p">,</span> <span class="s">&#39;u1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;xunit&#39;</span><span class="p">,</span> <span class="s">&#39;a11&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;stacktype_t&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
<span class="p">]</span>
<span class="c">#NIH_COLORTABLE_TYPE = (</span>
<span class="c">#    &#39;CustomTable&#39;, &#39;AppleDefault&#39;, &#39;Pseudo20&#39;, &#39;Pseudo32&#39;, &#39;Rainbow&#39;,</span>
<span class="c">#    &#39;Fire1&#39;, &#39;Fire2&#39;, &#39;Ice&#39;, &#39;Grays&#39;, &#39;Spectrum&#39;)</span>
<span class="c">#NIH_LUTMODE_TYPE = (</span>
<span class="c">#    &#39;PseudoColor&#39;, &#39;OldAppleDefault&#39;, &#39;OldSpectrum&#39;, &#39;GrayScale&#39;,</span>
<span class="c">#    &#39;ColorLut&#39;, &#39;CustomGrayscale&#39;)</span>
<span class="c">#NIH_CURVEFIT_TYPE = (</span>
<span class="c">#    &#39;StraightLine&#39;, &#39;Poly2&#39;, &#39;Poly3&#39;, &#39;Poly4&#39;, &#39;Poly5&#39;, &#39;ExpoFit&#39;,</span>
<span class="c">#    &#39;PowerFit&#39;, &#39;LogFit&#39;, &#39;RodbardFit&#39;, &#39;SpareFit1&#39;, &#39;Uncalibrated&#39;,</span>
<span class="c">#    &#39;UncalibratedOD&#39;)</span>
<span class="c">#NIH_UNITS_TYPE = (</span>
<span class="c">#    &#39;Nanometers&#39;, &#39;Micrometers&#39;, &#39;Millimeters&#39;, &#39;Centimeters&#39;, &#39;Meters&#39;,</span>
<span class="c">#    &#39;Kilometers&#39;, &#39;Inches&#39;, &#39;Feet&#39;, &#39;Miles&#39;, &#39;Pixels&#39;, &#39;OtherUnits&#39;)</span>
<span class="c">#NIH_STACKTYPE_TYPE = (</span>
<span class="c">#    &#39;VolumeStack&#39;, &#39;RGBStack&#39;, &#39;MovieStack&#39;, &#39;HSVStack&#39;)</span>
<span class="c"># MetaMorph STK tags</span>
<span class="n">MM_TAG_IDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;auto_scale&#39;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;min_scale&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;max_scale&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;spatial_calibration&#39;</span><span class="p">,</span>
    <span class="c">#4: &#39;x_calibration&#39;,</span>
    <span class="c">#5: &#39;y_calibration&#39;,</span>
    <span class="c">#6: &#39;calibration_units&#39;,</span>
    <span class="c">#7: &#39;name&#39;,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;thresh_state&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s">&#39;thresh_state_red&#39;</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s">&#39;thresh_state_green&#39;</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s">&#39;thresh_state_blue&#39;</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s">&#39;thresh_state_lo&#39;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s">&#39;thresh_state_hi&#39;</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s">&#39;zoom&#39;</span><span class="p">,</span>
    <span class="c">#16: &#39;create_time&#39;,</span>
    <span class="c">#17: &#39;last_saved_time&#39;,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s">&#39;current_buffer&#39;</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s">&#39;gray_fit&#39;</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s">&#39;gray_point_count&#39;</span><span class="p">,</span>
    <span class="c">#21: &#39;gray_x&#39;,</span>
    <span class="c">#22: &#39;gray_y&#39;,</span>
    <span class="c">#23: &#39;gray_min&#39;,</span>
    <span class="c">#24: &#39;gray_max&#39;,</span>
    <span class="c">#25: &#39;gray_unit_name&#39;,</span>
    <span class="mi">26</span><span class="p">:</span> <span class="s">&#39;standard_lut&#39;</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">:</span> <span class="s">&#39;wavelength&#39;</span><span class="p">,</span>
    <span class="c">#28: &#39;stage_position&#39;,</span>
    <span class="c">#29: &#39;camera_chip_offset&#39;,</span>
    <span class="c">#30: &#39;overlay_mask&#39;,</span>
    <span class="c">#31: &#39;overlay_compress&#39;,</span>
    <span class="c">#32: &#39;overlay&#39;,</span>
    <span class="c">#33: &#39;special_overlay_mask&#39;,</span>
    <span class="c">#34: &#39;special_overlay_compress&#39;,</span>
    <span class="c">#35: &#39;special_overlay&#39;,</span>
    <span class="mi">36</span><span class="p">:</span> <span class="s">&#39;image_property&#39;</span><span class="p">,</span>
    <span class="c">#37: &#39;stage_label&#39;,</span>
    <span class="c">#38: &#39;autoscale_lo_info&#39;,</span>
    <span class="c">#39: &#39;autoscale_hi_info&#39;,</span>
    <span class="c">#40: &#39;absolute_z&#39;,</span>
    <span class="c">#41: &#39;absolute_z_valid&#39;,</span>
    <span class="c">#42: &#39;gamma&#39;,</span>
    <span class="c">#43: &#39;gamma_red&#39;,</span>
    <span class="c">#44: &#39;gamma_green&#39;,</span>
    <span class="c">#45: &#39;gamma_blue&#39;,</span>
    <span class="c">#46: &#39;camera_bin&#39;,</span>
    <span class="mi">47</span><span class="p">:</span> <span class="s">&#39;new_lut&#39;</span><span class="p">,</span>
    <span class="c">#48: &#39;image_property_ex&#39;,</span>
    <span class="mi">49</span><span class="p">:</span> <span class="s">&#39;plane_property&#39;</span><span class="p">,</span>
    <span class="c">#50: &#39;user_lut_table&#39;,</span>
    <span class="mi">51</span><span class="p">:</span> <span class="s">&#39;red_autoscale_info&#39;</span><span class="p">,</span>
    <span class="c">#52: &#39;red_autoscale_lo_info&#39;,</span>
    <span class="c">#53: &#39;red_autoscale_hi_info&#39;,</span>
    <span class="mi">54</span><span class="p">:</span> <span class="s">&#39;red_minscale_info&#39;</span><span class="p">,</span>
    <span class="mi">55</span><span class="p">:</span> <span class="s">&#39;red_maxscale_info&#39;</span><span class="p">,</span>
    <span class="mi">56</span><span class="p">:</span> <span class="s">&#39;green_autoscale_info&#39;</span><span class="p">,</span>
    <span class="c">#57: &#39;green_autoscale_lo_info&#39;,</span>
    <span class="c">#58: &#39;green_autoscale_hi_info&#39;,</span>
    <span class="mi">59</span><span class="p">:</span> <span class="s">&#39;green_minscale_info&#39;</span><span class="p">,</span>
    <span class="mi">60</span><span class="p">:</span> <span class="s">&#39;green_maxscale_info&#39;</span><span class="p">,</span>
    <span class="mi">61</span><span class="p">:</span> <span class="s">&#39;blue_autoscale_info&#39;</span><span class="p">,</span>
    <span class="c">#62: &#39;blue_autoscale_lo_info&#39;,</span>
    <span class="c">#63: &#39;blue_autoscale_hi_info&#39;,</span>
    <span class="mi">64</span><span class="p">:</span> <span class="s">&#39;blue_min_scale_info&#39;</span><span class="p">,</span>
    <span class="mi">65</span><span class="p">:</span> <span class="s">&#39;blue_max_scale_info&#39;</span><span class="p">,</span>
    <span class="c">#66: &#39;overlay_plane_color&#39;</span>
<span class="p">}</span>
<span class="c"># Olympus FluoView</span>
<span class="n">MM_DIMENSION</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;a16&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;size&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;origin&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;resolution&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;unit&#39;</span><span class="p">,</span> <span class="s">&#39;a64&#39;</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">MM_HEADER</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">&#39;header_flag&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;image_type&#39;</span><span class="p">,</span> <span class="s">&#39;u1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;image_name&#39;</span><span class="p">,</span> <span class="s">&#39;a257&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_data&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;palette_size&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_palette0&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_palette1&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;comment_size&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_comment&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;dimensions&#39;</span><span class="p">,</span> <span class="n">MM_DIMENSION</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_position&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;map_type&#39;</span><span class="p">,</span> <span class="s">&#39;i2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;map_min&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;map_max&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;min_value&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;max_value&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_map&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;gamma&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;gray_channel&#39;</span><span class="p">,</span> <span class="n">MM_DIMENSION</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_thumbnail&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;voice_field&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_voice_field&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
<span class="p">]</span>
<span class="c"># Carl Zeiss LSM</span>
<span class="n">CZ_LSM_INFO</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">&#39;magic_number&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;structure_size&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;dimension_x&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;dimension_y&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;dimension_z&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;dimension_channels&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;dimension_time&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;dimension_data_type&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;thumbnail_x&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;thumbnail_y&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;voxel_size_x&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;voxel_size_y&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;voxel_size_z&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;origin_x&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;origin_y&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;origin_z&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;scan_type&#39;</span><span class="p">,</span> <span class="s">&#39;u2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;spectral_scan&#39;</span><span class="p">,</span> <span class="s">&#39;u2&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;data_type&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_vector_overlay&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_input_lut&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_output_lut&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_channel_colors&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;time_interval&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_channel_data_types&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_scan_information&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_ks_data&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_time_stamps&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_event_list&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_roi&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_bleach_roi&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_next_recording&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;display_aspect_x&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;display_aspect_y&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;display_aspect_z&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;display_aspect_time&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_mean_of_roi_overlay&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_topo_isoline_overlay&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_topo_profile_overlay&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_linescan_overlay&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;offset_toolbar_flags&#39;</span><span class="p">,</span> <span class="s">&#39;u4&#39;</span><span class="p">),</span>
<span class="p">]</span>
<span class="c"># Import functions for LSM_INFO sub-records</span>
<span class="n">CZ_LSM_INFO_READERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;scan_information&#39;</span><span class="p">:</span> <span class="n">read_cz_lsm_scan_info</span><span class="p">,</span>
    <span class="s">&#39;time_stamps&#39;</span><span class="p">:</span> <span class="n">read_cz_lsm_time_stamps</span><span class="p">,</span>
    <span class="s">&#39;event_list&#39;</span><span class="p">:</span> <span class="n">read_cz_lsm_event_list</span><span class="p">,</span>
<span class="p">}</span>
<span class="c"># Map cz_lsm_info.scan_type to dimension order</span>
<span class="n">CZ_SCAN_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c"># x-y-z scan</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c"># z scan (x-z plane)</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c"># line scan</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c"># time series x-y</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;XYZTC&#39;</span><span class="p">,</span>  <span class="c"># time series x-z</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c"># time series &#39;Mean of ROIs&#39;</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;XYZTC&#39;</span><span class="p">,</span>  <span class="c"># time series x-y-z</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;XYCTZ&#39;</span><span class="p">,</span>  <span class="c"># spline scan</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;XYCZT&#39;</span><span class="p">,</span>  <span class="c"># spline scan x-z</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c"># time series spline plane x-z</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c"># point mode</span>
<span class="p">}</span>
<span class="c"># Map dimension codes to cz_lsm_info attribute</span>
<span class="n">CZ_DIMENSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="s">&#39;dimension_x&#39;</span><span class="p">,</span>
    <span class="s">&#39;Y&#39;</span><span class="p">:</span> <span class="s">&#39;dimension_y&#39;</span><span class="p">,</span>
    <span class="s">&#39;Z&#39;</span><span class="p">:</span> <span class="s">&#39;dimension_z&#39;</span><span class="p">,</span>
    <span class="s">&#39;C&#39;</span><span class="p">:</span> <span class="s">&#39;dimension_channels&#39;</span><span class="p">,</span>
    <span class="s">&#39;T&#39;</span><span class="p">:</span> <span class="s">&#39;dimension_time&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="c"># Descriptions of cz_lsm_info.data_type</span>
<span class="n">CZ_DATA_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;varying data types&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;12 bit unsigned integer&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;32 bit float&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">CZ_LSM_SCAN_INFO_ARRAYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x20000000</span><span class="p">:</span> <span class="s">&quot;tracks&quot;</span><span class="p">,</span>
    <span class="mh">0x30000000</span><span class="p">:</span> <span class="s">&quot;lasers&quot;</span><span class="p">,</span>
    <span class="mh">0x60000000</span><span class="p">:</span> <span class="s">&quot;detectionchannels&quot;</span><span class="p">,</span>
    <span class="mh">0x80000000</span><span class="p">:</span> <span class="s">&quot;illuminationchannels&quot;</span><span class="p">,</span>
    <span class="mh">0xa0000000</span><span class="p">:</span> <span class="s">&quot;beamsplitters&quot;</span><span class="p">,</span>
    <span class="mh">0xc0000000</span><span class="p">:</span> <span class="s">&quot;datachannels&quot;</span><span class="p">,</span>
    <span class="mh">0x13000000</span><span class="p">:</span> <span class="s">&quot;markers&quot;</span><span class="p">,</span>
    <span class="mh">0x11000000</span><span class="p">:</span> <span class="s">&quot;timers&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">CZ_LSM_SCAN_INFO_STRUCTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x40000000</span><span class="p">:</span> <span class="s">&quot;tracks&quot;</span><span class="p">,</span>
    <span class="mh">0x50000000</span><span class="p">:</span> <span class="s">&quot;lasers&quot;</span><span class="p">,</span>
    <span class="mh">0x70000000</span><span class="p">:</span> <span class="s">&quot;detectionchannels&quot;</span><span class="p">,</span>
    <span class="mh">0x90000000</span><span class="p">:</span> <span class="s">&quot;illuminationchannels&quot;</span><span class="p">,</span>
    <span class="mh">0xb0000000</span><span class="p">:</span> <span class="s">&quot;beamsplitters&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000000</span><span class="p">:</span> <span class="s">&quot;datachannels&quot;</span><span class="p">,</span>
    <span class="mh">0x14000000</span><span class="p">:</span> <span class="s">&quot;markers&quot;</span><span class="p">,</span>
    <span class="mh">0x12000000</span><span class="p">:</span> <span class="s">&quot;timers&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">CZ_LSM_SCAN_INFO_ATTRIBUTES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x10000001</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="mh">0x10000002</span><span class="p">:</span> <span class="s">&quot;description&quot;</span><span class="p">,</span>
    <span class="mh">0x10000003</span><span class="p">:</span> <span class="s">&quot;notes&quot;</span><span class="p">,</span>
    <span class="mh">0x10000004</span><span class="p">:</span> <span class="s">&quot;objective&quot;</span><span class="p">,</span>
    <span class="mh">0x10000005</span><span class="p">:</span> <span class="s">&quot;processing_summary&quot;</span><span class="p">,</span>
    <span class="mh">0x10000006</span><span class="p">:</span> <span class="s">&quot;special_scan_mode&quot;</span><span class="p">,</span>
    <span class="mh">0x10000007</span><span class="p">:</span> <span class="s">&quot;oledb_recording_scan_type&quot;</span><span class="p">,</span>
    <span class="mh">0x10000008</span><span class="p">:</span> <span class="s">&quot;oledb_recording_scan_mode&quot;</span><span class="p">,</span>
    <span class="mh">0x10000009</span><span class="p">:</span> <span class="s">&quot;number_of_stacks&quot;</span><span class="p">,</span>
    <span class="mh">0x1000000a</span><span class="p">:</span> <span class="s">&quot;lines_per_plane&quot;</span><span class="p">,</span>
    <span class="mh">0x1000000b</span><span class="p">:</span> <span class="s">&quot;samples_per_line&quot;</span><span class="p">,</span>
    <span class="mh">0x1000000c</span><span class="p">:</span> <span class="s">&quot;planes_per_volume&quot;</span><span class="p">,</span>
    <span class="mh">0x1000000d</span><span class="p">:</span> <span class="s">&quot;images_width&quot;</span><span class="p">,</span>
    <span class="mh">0x1000000e</span><span class="p">:</span> <span class="s">&quot;images_height&quot;</span><span class="p">,</span>
    <span class="mh">0x1000000f</span><span class="p">:</span> <span class="s">&quot;images_number_planes&quot;</span><span class="p">,</span>
    <span class="mh">0x10000010</span><span class="p">:</span> <span class="s">&quot;images_number_stacks&quot;</span><span class="p">,</span>
    <span class="mh">0x10000011</span><span class="p">:</span> <span class="s">&quot;images_number_channels&quot;</span><span class="p">,</span>
    <span class="mh">0x10000012</span><span class="p">:</span> <span class="s">&quot;linscan_xy_size&quot;</span><span class="p">,</span>
    <span class="mh">0x10000013</span><span class="p">:</span> <span class="s">&quot;scan_direction&quot;</span><span class="p">,</span>
    <span class="mh">0x10000014</span><span class="p">:</span> <span class="s">&quot;time_series&quot;</span><span class="p">,</span>
    <span class="mh">0x10000015</span><span class="p">:</span> <span class="s">&quot;original_scan_data&quot;</span><span class="p">,</span>
    <span class="mh">0x10000016</span><span class="p">:</span> <span class="s">&quot;zoom_x&quot;</span><span class="p">,</span>
    <span class="mh">0x10000017</span><span class="p">:</span> <span class="s">&quot;zoom_y&quot;</span><span class="p">,</span>
    <span class="mh">0x10000018</span><span class="p">:</span> <span class="s">&quot;zoom_z&quot;</span><span class="p">,</span>
    <span class="mh">0x10000019</span><span class="p">:</span> <span class="s">&quot;sample_0x&quot;</span><span class="p">,</span>
    <span class="mh">0x1000001a</span><span class="p">:</span> <span class="s">&quot;sample_0y&quot;</span><span class="p">,</span>
    <span class="mh">0x1000001b</span><span class="p">:</span> <span class="s">&quot;sample_0z&quot;</span><span class="p">,</span>
    <span class="mh">0x1000001c</span><span class="p">:</span> <span class="s">&quot;sample_spacing&quot;</span><span class="p">,</span>
    <span class="mh">0x1000001d</span><span class="p">:</span> <span class="s">&quot;line_spacing&quot;</span><span class="p">,</span>
    <span class="mh">0x1000001e</span><span class="p">:</span> <span class="s">&quot;plane_spacing&quot;</span><span class="p">,</span>
    <span class="mh">0x1000001f</span><span class="p">:</span> <span class="s">&quot;plane_width&quot;</span><span class="p">,</span>
    <span class="mh">0x10000020</span><span class="p">:</span> <span class="s">&quot;plane_height&quot;</span><span class="p">,</span>
    <span class="mh">0x10000021</span><span class="p">:</span> <span class="s">&quot;volume_depth&quot;</span><span class="p">,</span>
    <span class="mh">0x10000023</span><span class="p">:</span> <span class="s">&quot;nutation&quot;</span><span class="p">,</span>
    <span class="mh">0x10000034</span><span class="p">:</span> <span class="s">&quot;rotation&quot;</span><span class="p">,</span>
    <span class="mh">0x10000035</span><span class="p">:</span> <span class="s">&quot;precession&quot;</span><span class="p">,</span>
    <span class="mh">0x10000036</span><span class="p">:</span> <span class="s">&quot;sample_0time&quot;</span><span class="p">,</span>
    <span class="mh">0x10000037</span><span class="p">:</span> <span class="s">&quot;start_scan_trigger_in&quot;</span><span class="p">,</span>
    <span class="mh">0x10000038</span><span class="p">:</span> <span class="s">&quot;start_scan_trigger_out&quot;</span><span class="p">,</span>
    <span class="mh">0x10000039</span><span class="p">:</span> <span class="s">&quot;start_scan_event&quot;</span><span class="p">,</span>
    <span class="mh">0x10000040</span><span class="p">:</span> <span class="s">&quot;start_scan_time&quot;</span><span class="p">,</span>
    <span class="mh">0x10000041</span><span class="p">:</span> <span class="s">&quot;stop_scan_trigger_in&quot;</span><span class="p">,</span>
    <span class="mh">0x10000042</span><span class="p">:</span> <span class="s">&quot;stop_scan_trigger_out&quot;</span><span class="p">,</span>
    <span class="mh">0x10000043</span><span class="p">:</span> <span class="s">&quot;stop_scan_event&quot;</span><span class="p">,</span>
    <span class="mh">0x10000044</span><span class="p">:</span> <span class="s">&quot;stop_scan_time&quot;</span><span class="p">,</span>
    <span class="mh">0x10000045</span><span class="p">:</span> <span class="s">&quot;use_rois&quot;</span><span class="p">,</span>
    <span class="mh">0x10000046</span><span class="p">:</span> <span class="s">&quot;use_reduced_memory_rois&quot;</span><span class="p">,</span>
    <span class="mh">0x10000047</span><span class="p">:</span> <span class="s">&quot;user&quot;</span><span class="p">,</span>
    <span class="mh">0x10000048</span><span class="p">:</span> <span class="s">&quot;use_bccorrection&quot;</span><span class="p">,</span>
    <span class="mh">0x10000049</span><span class="p">:</span> <span class="s">&quot;position_bccorrection1&quot;</span><span class="p">,</span>
    <span class="mh">0x10000050</span><span class="p">:</span> <span class="s">&quot;position_bccorrection2&quot;</span><span class="p">,</span>
    <span class="mh">0x10000051</span><span class="p">:</span> <span class="s">&quot;interpolation_y&quot;</span><span class="p">,</span>
    <span class="mh">0x10000052</span><span class="p">:</span> <span class="s">&quot;camera_binning&quot;</span><span class="p">,</span>
    <span class="mh">0x10000053</span><span class="p">:</span> <span class="s">&quot;camera_supersampling&quot;</span><span class="p">,</span>
    <span class="mh">0x10000054</span><span class="p">:</span> <span class="s">&quot;camera_frame_width&quot;</span><span class="p">,</span>
    <span class="mh">0x10000055</span><span class="p">:</span> <span class="s">&quot;camera_frame_height&quot;</span><span class="p">,</span>
    <span class="mh">0x10000056</span><span class="p">:</span> <span class="s">&quot;camera_offset_x&quot;</span><span class="p">,</span>
    <span class="mh">0x10000057</span><span class="p">:</span> <span class="s">&quot;camera_offset_y&quot;</span><span class="p">,</span>
    <span class="c"># lasers</span>
    <span class="mh">0x50000001</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="mh">0x50000002</span><span class="p">:</span> <span class="s">&quot;acquire&quot;</span><span class="p">,</span>
    <span class="mh">0x50000003</span><span class="p">:</span> <span class="s">&quot;power&quot;</span><span class="p">,</span>
    <span class="c"># tracks</span>
    <span class="mh">0x40000001</span><span class="p">:</span> <span class="s">&quot;multiplex_type&quot;</span><span class="p">,</span>
    <span class="mh">0x40000002</span><span class="p">:</span> <span class="s">&quot;multiplex_order&quot;</span><span class="p">,</span>
    <span class="mh">0x40000003</span><span class="p">:</span> <span class="s">&quot;sampling_mode&quot;</span><span class="p">,</span>
    <span class="mh">0x40000004</span><span class="p">:</span> <span class="s">&quot;sampling_method&quot;</span><span class="p">,</span>
    <span class="mh">0x40000005</span><span class="p">:</span> <span class="s">&quot;sampling_number&quot;</span><span class="p">,</span>
    <span class="mh">0x40000006</span><span class="p">:</span> <span class="s">&quot;acquire&quot;</span><span class="p">,</span>
    <span class="mh">0x40000007</span><span class="p">:</span> <span class="s">&quot;sample_observation_time&quot;</span><span class="p">,</span>
    <span class="mh">0x4000000b</span><span class="p">:</span> <span class="s">&quot;time_between_stacks&quot;</span><span class="p">,</span>
    <span class="mh">0x4000000c</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="mh">0x4000000d</span><span class="p">:</span> <span class="s">&quot;collimator1_name&quot;</span><span class="p">,</span>
    <span class="mh">0x4000000e</span><span class="p">:</span> <span class="s">&quot;collimator1_position&quot;</span><span class="p">,</span>
    <span class="mh">0x4000000f</span><span class="p">:</span> <span class="s">&quot;collimator2_name&quot;</span><span class="p">,</span>
    <span class="mh">0x40000010</span><span class="p">:</span> <span class="s">&quot;collimator2_position&quot;</span><span class="p">,</span>
    <span class="mh">0x40000011</span><span class="p">:</span> <span class="s">&quot;is_bleach_track&quot;</span><span class="p">,</span>
    <span class="mh">0x40000012</span><span class="p">:</span> <span class="s">&quot;is_bleach_after_scan_number&quot;</span><span class="p">,</span>
    <span class="mh">0x40000013</span><span class="p">:</span> <span class="s">&quot;bleach_scan_number&quot;</span><span class="p">,</span>
    <span class="mh">0x40000014</span><span class="p">:</span> <span class="s">&quot;trigger_in&quot;</span><span class="p">,</span>
    <span class="mh">0x40000015</span><span class="p">:</span> <span class="s">&quot;trigger_out&quot;</span><span class="p">,</span>
    <span class="mh">0x40000016</span><span class="p">:</span> <span class="s">&quot;is_ratio_track&quot;</span><span class="p">,</span>
    <span class="mh">0x40000017</span><span class="p">:</span> <span class="s">&quot;bleach_count&quot;</span><span class="p">,</span>
    <span class="mh">0x40000018</span><span class="p">:</span> <span class="s">&quot;spi_center_wavelength&quot;</span><span class="p">,</span>
    <span class="mh">0x40000019</span><span class="p">:</span> <span class="s">&quot;pixel_time&quot;</span><span class="p">,</span>
    <span class="mh">0x40000021</span><span class="p">:</span> <span class="s">&quot;condensor_frontlens&quot;</span><span class="p">,</span>
    <span class="mh">0x40000023</span><span class="p">:</span> <span class="s">&quot;field_stop_value&quot;</span><span class="p">,</span>
    <span class="mh">0x40000024</span><span class="p">:</span> <span class="s">&quot;id_condensor_aperture&quot;</span><span class="p">,</span>
    <span class="mh">0x40000025</span><span class="p">:</span> <span class="s">&quot;condensor_aperture&quot;</span><span class="p">,</span>
    <span class="mh">0x40000026</span><span class="p">:</span> <span class="s">&quot;id_condensor_revolver&quot;</span><span class="p">,</span>
    <span class="mh">0x40000027</span><span class="p">:</span> <span class="s">&quot;condensor_filter&quot;</span><span class="p">,</span>
    <span class="mh">0x40000028</span><span class="p">:</span> <span class="s">&quot;id_transmission_filter1&quot;</span><span class="p">,</span>
    <span class="mh">0x40000029</span><span class="p">:</span> <span class="s">&quot;id_transmission1&quot;</span><span class="p">,</span>
    <span class="mh">0x40000030</span><span class="p">:</span> <span class="s">&quot;id_transmission_filter2&quot;</span><span class="p">,</span>
    <span class="mh">0x40000031</span><span class="p">:</span> <span class="s">&quot;id_transmission2&quot;</span><span class="p">,</span>
    <span class="mh">0x40000032</span><span class="p">:</span> <span class="s">&quot;repeat_bleach&quot;</span><span class="p">,</span>
    <span class="mh">0x40000033</span><span class="p">:</span> <span class="s">&quot;enable_spot_bleach_pos&quot;</span><span class="p">,</span>
    <span class="mh">0x40000034</span><span class="p">:</span> <span class="s">&quot;spot_bleach_posx&quot;</span><span class="p">,</span>
    <span class="mh">0x40000035</span><span class="p">:</span> <span class="s">&quot;spot_bleach_posy&quot;</span><span class="p">,</span>
    <span class="mh">0x40000036</span><span class="p">:</span> <span class="s">&quot;spot_bleach_posz&quot;</span><span class="p">,</span>
    <span class="mh">0x40000037</span><span class="p">:</span> <span class="s">&quot;id_tubelens&quot;</span><span class="p">,</span>
    <span class="mh">0x40000038</span><span class="p">:</span> <span class="s">&quot;id_tubelens_position&quot;</span><span class="p">,</span>
    <span class="mh">0x40000039</span><span class="p">:</span> <span class="s">&quot;transmitted_light&quot;</span><span class="p">,</span>
    <span class="mh">0x4000003a</span><span class="p">:</span> <span class="s">&quot;reflected_light&quot;</span><span class="p">,</span>
    <span class="mh">0x4000003b</span><span class="p">:</span> <span class="s">&quot;simultan_grab_and_bleach&quot;</span><span class="p">,</span>
    <span class="mh">0x4000003c</span><span class="p">:</span> <span class="s">&quot;bleach_pixel_time&quot;</span><span class="p">,</span>
    <span class="c"># detection_channels</span>
    <span class="mh">0x70000001</span><span class="p">:</span> <span class="s">&quot;integration_mode&quot;</span><span class="p">,</span>
    <span class="mh">0x70000002</span><span class="p">:</span> <span class="s">&quot;special_mode&quot;</span><span class="p">,</span>
    <span class="mh">0x70000003</span><span class="p">:</span> <span class="s">&quot;detector_gain_first&quot;</span><span class="p">,</span>
    <span class="mh">0x70000004</span><span class="p">:</span> <span class="s">&quot;detector_gain_last&quot;</span><span class="p">,</span>
    <span class="mh">0x70000005</span><span class="p">:</span> <span class="s">&quot;amplifier_gain_first&quot;</span><span class="p">,</span>
    <span class="mh">0x70000006</span><span class="p">:</span> <span class="s">&quot;amplifier_gain_last&quot;</span><span class="p">,</span>
    <span class="mh">0x70000007</span><span class="p">:</span> <span class="s">&quot;amplifier_offs_first&quot;</span><span class="p">,</span>
    <span class="mh">0x70000008</span><span class="p">:</span> <span class="s">&quot;amplifier_offs_last&quot;</span><span class="p">,</span>
    <span class="mh">0x70000009</span><span class="p">:</span> <span class="s">&quot;pinhole_diameter&quot;</span><span class="p">,</span>
    <span class="mh">0x7000000a</span><span class="p">:</span> <span class="s">&quot;counting_trigger&quot;</span><span class="p">,</span>
    <span class="mh">0x7000000b</span><span class="p">:</span> <span class="s">&quot;acquire&quot;</span><span class="p">,</span>
    <span class="mh">0x7000000c</span><span class="p">:</span> <span class="s">&quot;point_detector_name&quot;</span><span class="p">,</span>
    <span class="mh">0x7000000d</span><span class="p">:</span> <span class="s">&quot;amplifier_name&quot;</span><span class="p">,</span>
    <span class="mh">0x7000000e</span><span class="p">:</span> <span class="s">&quot;pinhole_name&quot;</span><span class="p">,</span>
    <span class="mh">0x7000000f</span><span class="p">:</span> <span class="s">&quot;filter_set_name&quot;</span><span class="p">,</span>
    <span class="mh">0x70000010</span><span class="p">:</span> <span class="s">&quot;filter_name&quot;</span><span class="p">,</span>
    <span class="mh">0x70000013</span><span class="p">:</span> <span class="s">&quot;integrator_name&quot;</span><span class="p">,</span>
    <span class="mh">0x70000014</span><span class="p">:</span> <span class="s">&quot;detection_channel_name&quot;</span><span class="p">,</span>
    <span class="mh">0x70000015</span><span class="p">:</span> <span class="s">&quot;detection_detector_gain_bc1&quot;</span><span class="p">,</span>
    <span class="mh">0x70000016</span><span class="p">:</span> <span class="s">&quot;detection_detector_gain_bc2&quot;</span><span class="p">,</span>
    <span class="mh">0x70000017</span><span class="p">:</span> <span class="s">&quot;detection_amplifier_gain_bc1&quot;</span><span class="p">,</span>
    <span class="mh">0x70000018</span><span class="p">:</span> <span class="s">&quot;detection_amplifier_gain_bc2&quot;</span><span class="p">,</span>
    <span class="mh">0x70000019</span><span class="p">:</span> <span class="s">&quot;detection_amplifier_offset_bc1&quot;</span><span class="p">,</span>
    <span class="mh">0x70000020</span><span class="p">:</span> <span class="s">&quot;detection_amplifier_offset_bc2&quot;</span><span class="p">,</span>
    <span class="mh">0x70000021</span><span class="p">:</span> <span class="s">&quot;detection_spectral_scan_channels&quot;</span><span class="p">,</span>
    <span class="mh">0x70000022</span><span class="p">:</span> <span class="s">&quot;detection_spi_wavelength_start&quot;</span><span class="p">,</span>
    <span class="mh">0x70000023</span><span class="p">:</span> <span class="s">&quot;detection_spi_wavelength_stop&quot;</span><span class="p">,</span>
    <span class="mh">0x70000026</span><span class="p">:</span> <span class="s">&quot;detection_dye_name&quot;</span><span class="p">,</span>
    <span class="mh">0x70000027</span><span class="p">:</span> <span class="s">&quot;detection_dye_folder&quot;</span><span class="p">,</span>
    <span class="c"># illumination_channels</span>
    <span class="mh">0x90000001</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="mh">0x90000002</span><span class="p">:</span> <span class="s">&quot;power&quot;</span><span class="p">,</span>
    <span class="mh">0x90000003</span><span class="p">:</span> <span class="s">&quot;wavelength&quot;</span><span class="p">,</span>
    <span class="mh">0x90000004</span><span class="p">:</span> <span class="s">&quot;aquire&quot;</span><span class="p">,</span>
    <span class="mh">0x90000005</span><span class="p">:</span> <span class="s">&quot;detchannel_name&quot;</span><span class="p">,</span>
    <span class="mh">0x90000006</span><span class="p">:</span> <span class="s">&quot;power_bc1&quot;</span><span class="p">,</span>
    <span class="mh">0x90000007</span><span class="p">:</span> <span class="s">&quot;power_bc2&quot;</span><span class="p">,</span>
    <span class="c"># beam_splitters</span>
    <span class="mh">0xb0000001</span><span class="p">:</span> <span class="s">&quot;filter_set&quot;</span><span class="p">,</span>
    <span class="mh">0xb0000002</span><span class="p">:</span> <span class="s">&quot;filter&quot;</span><span class="p">,</span>
    <span class="mh">0xb0000003</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="c"># data_channels</span>
    <span class="mh">0xd0000001</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000003</span><span class="p">:</span> <span class="s">&quot;acquire&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000004</span><span class="p">:</span> <span class="s">&quot;color&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000005</span><span class="p">:</span> <span class="s">&quot;sample_type&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000006</span><span class="p">:</span> <span class="s">&quot;bits_per_sample&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000007</span><span class="p">:</span> <span class="s">&quot;ratio_type&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000008</span><span class="p">:</span> <span class="s">&quot;ratio_track1&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000009</span><span class="p">:</span> <span class="s">&quot;ratio_track2&quot;</span><span class="p">,</span>
    <span class="mh">0xd000000a</span><span class="p">:</span> <span class="s">&quot;ratio_channel1&quot;</span><span class="p">,</span>
    <span class="mh">0xd000000b</span><span class="p">:</span> <span class="s">&quot;ratio_channel2&quot;</span><span class="p">,</span>
    <span class="mh">0xd000000c</span><span class="p">:</span> <span class="s">&quot;ratio_const1&quot;</span><span class="p">,</span>
    <span class="mh">0xd000000d</span><span class="p">:</span> <span class="s">&quot;ratio_const2&quot;</span><span class="p">,</span>
    <span class="mh">0xd000000e</span><span class="p">:</span> <span class="s">&quot;ratio_const3&quot;</span><span class="p">,</span>
    <span class="mh">0xd000000f</span><span class="p">:</span> <span class="s">&quot;ratio_const4&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000010</span><span class="p">:</span> <span class="s">&quot;ratio_const5&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000011</span><span class="p">:</span> <span class="s">&quot;ratio_const6&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000012</span><span class="p">:</span> <span class="s">&quot;ratio_first_images1&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000013</span><span class="p">:</span> <span class="s">&quot;ratio_first_images2&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000014</span><span class="p">:</span> <span class="s">&quot;dye_name&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000015</span><span class="p">:</span> <span class="s">&quot;dye_folder&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000016</span><span class="p">:</span> <span class="s">&quot;spectrum&quot;</span><span class="p">,</span>
    <span class="mh">0xd0000017</span><span class="p">:</span> <span class="s">&quot;acquire&quot;</span><span class="p">,</span>
    <span class="c"># markers</span>
    <span class="mh">0x14000001</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="mh">0x14000002</span><span class="p">:</span> <span class="s">&quot;description&quot;</span><span class="p">,</span>
    <span class="mh">0x14000003</span><span class="p">:</span> <span class="s">&quot;trigger_in&quot;</span><span class="p">,</span>
    <span class="mh">0x14000004</span><span class="p">:</span> <span class="s">&quot;trigger_out&quot;</span><span class="p">,</span>
    <span class="c"># timers</span>
    <span class="mh">0x12000001</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
    <span class="mh">0x12000002</span><span class="p">:</span> <span class="s">&quot;description&quot;</span><span class="p">,</span>
    <span class="mh">0x12000003</span><span class="p">:</span> <span class="s">&quot;interval&quot;</span><span class="p">,</span>
    <span class="mh">0x12000004</span><span class="p">:</span> <span class="s">&quot;trigger_in&quot;</span><span class="p">,</span>
    <span class="mh">0x12000005</span><span class="p">:</span> <span class="s">&quot;trigger_out&quot;</span><span class="p">,</span>
    <span class="mh">0x12000006</span><span class="p">:</span> <span class="s">&quot;activation_time&quot;</span><span class="p">,</span>
    <span class="mh">0x12000007</span><span class="p">:</span> <span class="s">&quot;activation_number&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="c"># Map TIFF tag code to attribute name, default value, type, count, validator</span>
<span class="n">TIFF_TAGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">254</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;new_subfile_type&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TIFF_SUBFILE_TYPES</span><span class="p">()),</span>
    <span class="mi">255</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;subfile_type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
          <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;undefined&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;image&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;reduced_image&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;page&#39;</span><span class="p">}),</span>
    <span class="mi">256</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;image_width&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">257</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;image_length&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">258</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;bits_per_sample&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">259</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;compression&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TIFF_COMPESSIONS</span><span class="p">),</span>
    <span class="mi">262</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;photometric&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TIFF_PHOTOMETRICS</span><span class="p">),</span>
    <span class="mi">266</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;fill_order&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s">&#39;msb2lsb&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;lsb2msb&#39;</span><span class="p">}),</span>
    <span class="mi">269</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;document_name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">270</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;image_description&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">271</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;make&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">272</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">273</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;strip_offsets&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">274</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;orientation&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TIFF_ORIENTATIONS</span><span class="p">),</span>
    <span class="mi">277</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;samples_per_pixel&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">278</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;rows_per_strip&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">279</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;strip_byte_counts&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">280</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;min_sample_value&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">281</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;max_sample_value&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>  <span class="c"># 2**bits_per_sample</span>
    <span class="mi">282</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;x_resolution&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">283</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;y_resolution&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">284</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;planar_configuration&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s">&#39;contig&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;separate&#39;</span><span class="p">}),</span>
    <span class="mi">285</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;page_name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">286</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;x_position&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">287</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;y_position&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">296</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;resolution_unit&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;inch&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;centimeter&#39;</span><span class="p">}),</span>
    <span class="mi">297</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;page_number&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">305</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;software&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">306</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;datetime&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">315</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;artist&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">316</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;host_computer&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">317</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;predictor&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;horizontal&#39;</span><span class="p">}),</span>
    <span class="mi">320</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;color_map&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">322</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;tile_width&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">323</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;tile_length&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">324</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;tile_offsets&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">325</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;tile_byte_counts&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">338</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;extra_samples&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
          <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;unspecified&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;assocalpha&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;unassalpha&#39;</span><span class="p">}),</span>
    <span class="mi">339</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;sample_format&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TIFF_SAMPLE_FORMATS</span><span class="p">),</span>
    <span class="mi">347</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;jpeg_tables&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">530</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;ycbcr_subsampling&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">531</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;ycbcr_positioning&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">32997</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;image_depth&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">32998</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;tile_depth&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33432</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;copyright&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33445</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_file_tag&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33446</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_scale_pixel&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33447</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_color_table&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33448</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_lab_name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33449</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_sample_info&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33450</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_prep_date&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33451</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_prep_time&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33452</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;md_file_units&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33550</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;model_pixel_scale&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">33922</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;model_tie_point&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">37510</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;user_comment&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">34665</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;exif_ifd&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">34735</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;geo_key_directory&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">34736</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;geo_double_params&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">34737</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;geo_ascii_params&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">34853</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;gps_ifd&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">42112</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;gdal_metadata&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">42113</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;gdal_nodata&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50838</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;imagej_byte_counts&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50289</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_xy_position&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50290</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_z_position&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50291</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_xy_calibration&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50292</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_lens_lem_na_n&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50293</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_channel_name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50294</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_ex_wavelength&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">50295</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_time_stamp&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="mi">65200</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;flex_xml&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="c"># code: (attribute name, default value, type, count, validator)</span>
<span class="p">}</span>
<span class="c"># Map custom TIFF tag codes to attribute names and import functions</span>
<span class="n">CUSTOM_TAGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">700</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;xmp&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
    <span class="mi">34377</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;photoshop&#39;</span><span class="p">,</span> <span class="n">read_numpy</span><span class="p">),</span>
    <span class="mi">33723</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;iptc&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
    <span class="mi">34675</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;icc_profile&#39;</span><span class="p">,</span> <span class="n">read_numpy</span><span class="p">),</span>
    <span class="mi">33628</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mm_uic1&#39;</span><span class="p">,</span> <span class="n">read_mm_uic1</span><span class="p">),</span>
    <span class="mi">33629</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mm_uic2&#39;</span><span class="p">,</span> <span class="n">read_mm_uic2</span><span class="p">),</span>
    <span class="mi">33630</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mm_uic3&#39;</span><span class="p">,</span> <span class="n">read_mm_uic3</span><span class="p">),</span>
    <span class="mi">33631</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mm_uic4&#39;</span><span class="p">,</span> <span class="n">read_mm_uic4</span><span class="p">),</span>
    <span class="mi">34361</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mm_header&#39;</span><span class="p">,</span> <span class="n">read_mm_header</span><span class="p">),</span>
    <span class="mi">34362</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mm_stamp&#39;</span><span class="p">,</span> <span class="n">read_mm_stamp</span><span class="p">),</span>
    <span class="mi">34386</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mm_user_block&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
    <span class="mi">34412</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;cz_lsm_info&#39;</span><span class="p">,</span> <span class="n">read_cz_lsm_info</span><span class="p">),</span>
    <span class="mi">43314</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;nih_image_header&#39;</span><span class="p">,</span> <span class="n">read_nih_image_header</span><span class="p">),</span>
    <span class="c"># 40001: (&#39;mc_ipwinscal&#39;, read_bytes),</span>
    <span class="mi">40100</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_id_old&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
    <span class="mi">50288</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_id&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
    <span class="mi">50296</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;mc_frame_properties&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
    <span class="mi">50839</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;imagej_metadata&#39;</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">),</span>
    <span class="mi">51123</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;micromanager_metadata&#39;</span><span class="p">,</span> <span class="n">read_json</span><span class="p">),</span>
<span class="p">}</span>
<span class="c"># Max line length of printed output</span>
<span class="n">PRINT_LINE_LEN</span> <span class="o">=</span> <span class="mi">79</span>
<div class="viewcode-block" id="imshow"><a class="viewcode-back" href="../tifffile.html#tifffile.imshow">[docs]</a><span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">bitspersample</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s">&#39;rgb&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span>
           <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="mi">111</span><span class="p">,</span> <span class="n">maxdim</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot n-dimensional images using matplotlib.pyplot.</span>
<span class="sd">    Return figure, subplot and plot axis.</span>
<span class="sd">    Requires pyplot already imported ``from matplotlib import pyplot``.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bitspersample : int or None</span>
<span class="sd">        Number of bits per channel in integer RGB images.</span>
<span class="sd">    photometric : {&#39;miniswhite&#39;, &#39;minisblack&#39;, &#39;rgb&#39;, or &#39;palette&#39;}</span>
<span class="sd">        The color space of the image data.</span>
<span class="sd">    title : str</span>
<span class="sd">        Window and subplot title.</span>
<span class="sd">    figure : matplotlib.figure.Figure (optional).</span>
<span class="sd">        Matplotlib to use for plotting.</span>
<span class="sd">    subplot : int</span>
<span class="sd">        A matplotlib.pyplot.subplot axis.</span>
<span class="sd">    maxdim : int</span>
<span class="sd">        maximum image size in any dimension.</span>
<span class="sd">    kwargs : optional</span>
<span class="sd">        Arguments for matplotlib.pyplot.imshow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#if photometric not in (&#39;miniswhite&#39;, &#39;minisblack&#39;, &#39;rgb&#39;, &#39;palette&#39;):</span>
    <span class="c">#    raise ValueError(&quot;Can&#39;t handle %s photometrics&quot; % photometric)</span>
    <span class="c"># TODO: handle photometric == &#39;separated&#39; (CMYK)</span>
    <span class="n">isrgb</span> <span class="o">=</span> <span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;rgb&#39;</span><span class="p">,</span> <span class="s">&#39;palette&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxdim</span><span class="p">),</span> <span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not an image&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">dims</span> <span class="o">-=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">isrgb</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s">&#39;palette&#39;</span> <span class="ow">and</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">datamax</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>  <span class="c"># possible precision loss</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s">&#39;ui&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bitspersample</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bitspersample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bitspersample</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c"># bitspersample can be tuple, e.g. (5, 6, 5)</span>
            <span class="n">bitspersample</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitspersample</span>
        <span class="k">if</span> <span class="n">isrgb</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bitspersample</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">bitspersample</span>
            <span class="k">elif</span> <span class="n">bitspersample</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="n">bitspersample</span> <span class="o">-</span> <span class="mi">8</span>  <span class="c"># precision loss</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">datamax</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">/=</span> <span class="n">datamax</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;complex type&quot;</span><span class="p">)</span>  <span class="c"># TODO: handle complex types</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">datamax</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
                <span class="n">dtmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">dtmin</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">dtmin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
                <span class="n">dtmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">dtmin</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">dtmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pyplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;matplotlib.pyplot&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s">&#39;normal&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">10.3</span><span class="p">,</span> <span class="mf">6.3</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;1.0&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.03</span><span class="o">*</span><span class="p">(</span><span class="n">dims</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                               <span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">subplot</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subplot</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s">&#39;Windows-1252&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s">&#39;ub&#39;</span> <span class="ow">and</span> <span class="n">vmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s">&#39;gray&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s">&#39;coolwarm&#39;</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s">&#39;miniswhite&#39;</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">+=</span> <span class="s">&#39;_r&#39;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c"># panchor=(0.55, 0.5), fraction=0.05</span>
    <span class="k">def</span> <span class="nf">format_coord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c"># callback function to format coordinate display in toolbar</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> @ </span><span class="si">%s</span><span class="s"> [</span><span class="si">%4i</span><span class="s">, </span><span class="si">%4i</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_ax_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span>
                                               <span class="n">current</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> @ [</span><span class="si">%4i</span><span class="s">, </span><span class="si">%4i</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">format_coord</span>
    <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">)</span>
        <span class="n">cur_ax_dat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()]</span>
        <span class="n">sliders</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyplot</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.03</span><span class="o">*</span><span class="p">(</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.725</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">]),</span>
            <span class="s">&#39;Dimension </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;0.5&#39;</span><span class="p">,</span>
            <span class="n">valfmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%%</span><span class="s">.0f [</span><span class="si">%i</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">slider</span> <span class="ow">in</span> <span class="n">sliders</span><span class="p">:</span>
            <span class="n">slider</span><span class="o">.</span><span class="n">drawon</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">def</span> <span class="nf">set_image</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">sliders</span><span class="o">=</span><span class="n">sliders</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">):</span>
            <span class="c"># change image and redraw canvas</span>
            <span class="n">cur_ax_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">cur_ax_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sliders</span><span class="p">,</span> <span class="n">current</span><span class="p">):</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">eventson</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">eventson</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">on_changed</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">):</span>
            <span class="c"># callback function for slider change event</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="n">cur_ax_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">set_image</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">on_keypressed</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">):</span>
            <span class="c"># callback function for key press event</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">cur_ax_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="s">&#39;0123456789&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;left&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;up&#39;</span><span class="p">:</span>
                <span class="n">cur_ax_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;down&#39;</span><span class="p">:</span>
                <span class="n">cur_ax_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">axis</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;home&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">on_keypressed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sliders</span><span class="p">):</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">axis</span><span class="p">:</span> <span class="n">on_changed</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">figure</span><span class="p">,</span> <span class="n">subplot</span><span class="p">,</span> <span class="n">image</span></div>
<span class="k">def</span> <span class="nf">_app_show</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Block the GUI. For use as skimage plugin.&quot;&quot;&quot;</span>
    <span class="n">pyplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;matplotlib.pyplot&#39;</span><span class="p">]</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Command line usage main function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">2.6</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This script requires Python version 2.6 or better.&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This is Python version </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">argv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
    <span class="kn">import</span> <span class="nn">optparse</span>
    <span class="n">search_doc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">__doc__</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">__doc__</span> <span class="k">else</span> <span class="n">d</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span>
        <span class="n">usage</span><span class="o">=</span><span class="s">&quot;usage: %prog [options] path&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">search_doc</span><span class="p">(</span><span class="s">&quot;^([^</span><span class="se">\n</span><span class="s">]+)&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
        <span class="n">version</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%%</span><span class="s">prog </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">search_doc</span><span class="p">(</span><span class="s">&quot;:Version: (.*)&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">))</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--page&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;display single page&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--series&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;series&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;display series of pages of same shape&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;--nomultifile&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;nomultifile&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;don&#39;t read OME series from multiple files&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;--noplot&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;noplot&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;don&#39;t display images&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;--interpol&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;interpol&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;INTERPOL&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;bilinear&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;image interpolation method&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;--dpi&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dpi&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;set plot resolution&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;raise exception on failures&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;--test&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;try read all images in path&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;--doctest&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;doctest&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;runs the internal tests&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_false&#39;</span><span class="p">)</span>
    <span class="n">settings</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">doctest</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">doctest</span>
        <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;No file specified&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
        <span class="n">test_tifffile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s">&#39;?*&#39;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;no files match the pattern&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c"># TODO: handle image sequences</span>
        <span class="c">#if len(path) == 1:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Reading file structure...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tif</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">multifile</span><span class="o">=</span><span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">nomultifile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s"> ms&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">norgb</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">None</span><span class="p">,</span> <span class="n">tif</span><span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">page</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">page</span><span class="p">])]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">noplot</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Reading image data... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">notnone</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">page</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">page</span><span class="p">),</span>
                           <span class="n">tif</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">page</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">series</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">),</span>
                           <span class="n">notnone</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">pages</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">i</span><span class="p">),</span> <span class="n">notnone</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="n">notnone</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">* series </span><span class="si">%i</span><span class="s"> failed: </span><span class="si">%s</span><span class="s">... &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                                  <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s"> ms&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">tif</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">TIFF file:&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">):</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Series </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">print</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_palette</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Color Map:&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;cz_lsm_info&#39;</span><span class="p">,</span> <span class="s">&#39;cz_lsm_scan_information&#39;</span><span class="p">,</span> <span class="s">&#39;mm_uic_tags&#39;</span><span class="p">,</span>
                     <span class="s">&#39;mm_header&#39;</span><span class="p">,</span> <span class="s">&#39;imagej_tags&#39;</span><span class="p">,</span> <span class="s">&#39;micromanager_metadata&#39;</span><span class="p">,</span>
                     <span class="s">&#39;nih_image_header&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">Record</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">attr</span><span class="p">)),</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_micromanager</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;MICROMANAGER_FILE_METADATA&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">Record</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">micromanager_metadata</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">images</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">noplot</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;TkAgg&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;failed to import matplotlib.</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="s">&#39;gdal_nodata&#39;</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">gdal_nodata</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">mm_uic_tags</span><span class="p">[</span><span class="s">&#39;min_scale&#39;</span><span class="p">]</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">mm_uic_tags</span><span class="p">[</span><span class="s">&#39;max_scale&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vmax</span> <span class="o">&lt;=</span> <span class="n">vmin</span><span class="p">:</span>
                            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tif</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
                <span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                       <span class="n">bitspersample</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">bits_per_sample</span><span class="p">,</span>
                       <span class="n">photometric</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">photometric</span><span class="p">,</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">interpol</span><span class="p">,</span>
                       <span class="n">dpi</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">TIFFfile</span> <span class="o">=</span> <span class="n">TiffFile</span>  <span class="c"># backwards compatibility</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="nb">basestring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span>
    <span class="nb">unicode</span> <span class="o">=</span> <span class="nb">str</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Embryo Pre-processing 0.0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, James Brown.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>