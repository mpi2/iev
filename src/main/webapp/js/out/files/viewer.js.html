<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>viewer.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/EmbryoViewer.html">EmbryoViewer</a></li>
                                <li><a href="../classes/SpcimenView.html">SpcimenView</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: viewer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
//goog.require(&#x27;X.renderer2D&#x27;);
//goog.require(&#x27;X.interactor2D&#x27;);


(function () {
    if (typeof dcc === &#x27;undefined&#x27;)
        dcc = {};


    function SpecimenView(volumePaths, id, container, queryColonyId, indexCallback) {
        /**
         * This class holds the three orthogonal views from a single specimen and 
         * allows for loading in of differnt specimens of the same genenotype/colonyID
         * 
         * @class SpcimenView
         * @param {Array} VolumePaths volumes paths for a specific mutant/baseline
         * @param {int} id unique id for this view
         * @param {String} container html element to place this view
         * @param {String} queryColonyId The colonyId of this specimen
         * @param {function} indexCallBack called when slice index changes
         */

        var id = id;
        var viewContainer = container;
        var volumePaths = volumePaths;
        var currentVolumePath = volumePaths[0];

        var $xContainer;
        var $yContainer;
        var $zContainer;
        var $xWrap;
        var $yWrap;
        var $zWrap;
        var $xSlider;
        var $ySlider;
        var $zSlider;
        var $windowLevel;
        var xRen;
        var yRen;
        var zRen;
        var volume;
        var invertColours = &#x27;invert_colours_&#x27; + id;
        var windowLevel = &#x27;windowLevel_&#x27; + id;
        var reset = &#x27;reset_&#x27; + id;
        var zoomIn = &#x27;zoomIn_&#x27; + id;
        var zoomOut = &#x27;zoomOut_&#x27; + id;
        var vselector = &#x27;volumeSelector_&#x27; + id;
        var xOffset = 0;
        var yOffset = 0;
        var zOffset = 0;


        function createEventHandlers() {
            /**
             * Create event handler for controlling the specimen view
             * 
             * @method createEventHandlers
             * 
             */
   
            // Invert the color map 
            $(&quot;#&quot; + invertColours).change($.proxy(function (e) {
                invertColour(e.target.checked);
            }, this));

            
            $windowLevel = $(&#x27;#&#x27; + windowLevel);
            
            $windowLevel.slider({
                range: true,
//                min: parseInt(volume.windowLow),
//                max: parseInt(volume.windowHigh),
                min: 0, // TODO: remove hard coding
                max: 256,
                step: 1,
                //values: [ parseInt(volume.windowLow), parseInt(volume.windowHigh) ],
                values: [0, 200],
                slide: $.proxy(function (event, ui) {
                    volume.windowLow = ui.values[0];
                    volume.windowHigh = ui.values[1];
                    volume.modified(true);
                }, this)
            });

            $(&#x27;#windowLevel_mut&#x27;).tooltip({content: &quot;gjdfhs&quot;,
                 show: {delay: 1000 }
             });

            $(&quot;#&quot; + reset)
            .button()
            .click($.proxy(function () {
                  //reset the zoom
                  xRen.resetViewAndRender();
                  yRen.resetViewAndRender();
                  zRen.resetViewAndRender();
                  //Reset the slider position
                  var dims = volume.dimensions;
                  volume.indexX = Math.floor((dims[0] - 1) / 2);
                  volume.indexY = Math.floor((dims[1] - 1) / 2);
                  volume.indexZ = Math.floor((dims[2] - 1) / 2);
                  $xSlider.slider(&quot;value&quot;, volume.indexX);
                  $ySlider.slider(&quot;value&quot;, volume.indexY);
                  $zSlider.slider(&quot;value&quot;, volume.indexZ);
                  //reset the window level
                  $windowLevel.slider(&quot;option&quot;, &quot;values&quot;, [volume.windowLow, volume.windowHigh]);
            }, this));



            $(&quot;#&quot; + zoomIn)
            .button()
            .click($.proxy(function () {
                xRen.camera.zoomIn(false);
                yRen.camera.zoomIn(false);
                zRen.camera.zoomIn(false);
            }, this));


            $(&quot;#&quot; + zoomOut)
            .button()
            .click($.proxy(function () {
                xRen.camera.zoomOut(false);
                yRen.camera.zoomOut(false);
                zRen.camera.zoomOut(false);
            }, this));
            

            // Add the volume options
            var options = [];
            for (i = 0; i &lt; volumePaths.length; i++) {
                options.push(&quot;&lt;option value=&#x27;&quot; + volumePaths[i] + &quot;&#x27;&gt;&quot; + basename(volumePaths[i]) + &quot;&lt;/option&gt;&quot;);
            }
            

            $(&#x27;#&#x27; + vselector)
            .append(options.join(&quot;&quot;))
            .selectmenu({
                width: 200,
                height: 20,
                change: $.proxy(function (event, ui) {
                    replaceVolume(ui.item.value);
                }, this)
            });
        }; 



        function createHTML () {
            /**
             * Creates the html needed for the specimen view to live in.
             * Uses handlebar.js to generate from templates
             * 
             * @method createHtml
             * 
             */

            var $viewsContainer = $(&quot;#&quot; + viewContainer);
            
            if (volumePaths.length &lt; 1 &amp;&amp; queryColonyId !==  null){
                    return;
            }
            
            var data = {
                id: id
            };
            
            var source   = $(&quot;#specimen_view_template&quot;).html();
            var template = Handlebars.compile(source);
            
            var $specimenView = $(template(data));
            
            $specimenView.append(controls_tab());
      
            // This defines the order of the orthogonal views
            $specimenView.append(createSliceView(&#x27;X&#x27;));
            $specimenView.append(createSliceView(&#x27;Y&#x27;));
            $specimenView.append(createSliceView(&#x27;Z&#x27;));

            $viewsContainer.append($specimenView);
        }
        
        
        function createSliceView(orient){
            /**
             * 
             * @param {String} orient Orientation (X, Y or Z)
             */
            
            var data = {
                sliceWrapId: &#x27;sliceWrap_&#x27; + orient + &#x27;_&#x27; + id,
                sliceContainerID: orient + &#x27;_&#x27; + id,
                viewSliceClasss: &#x27;slice&#x27; + orient,
                sliderId: &#x27;slider_&#x27; + orient + &#x27;_&#x27;+ id,
                sliderClass: &#x27;slider&#x27; + orient,
                orientation: orient,
                id: id
               
            };
            
            var source   = $(&quot;#slice_view_template&quot;).html();
            var template = Handlebars.compile(source);
            return template(data);
        }
        
           
        
        function jQuerySelectors(){
            /**
             * Get Jquery handles on elements that need to be accessed multiple times
             * Should speed things up not having to query the DOM all the time
             * 
             * @method jQuerySelectors
             */
            $xContainer =  $(&#x27;#X_&#x27; + id);
            $yContainer =  $(&#x27;#Y_&#x27; + id);
            $zContainer =  $(&#x27;#Z_&#x27; + id);
            $xSlider = $(&#x27;#slider_X_&#x27;+ id);
            $ySlider = $(&#x27;#slider_Y_&#x27;+ id);
            $zSlider = $(&#x27;#slider_Z_&#x27;+ id);
            $xWrap = $(&#x27;#sliceWrap_X_&#x27; + id);
            $yWrap = $(&#x27;#sliceWrap_Y_&#x27; + id);
            $zWrap = $(&#x27;#sliceWrap_Z_&#x27; + id);
        }
        
        

        function controls_tab() {
            /**
             * Use handlebars.js to the controls tab HTML for the specimen view
             * Controls tab contains zoom buttons contrst slider etc.
             * 
             * @method controls_tab
             * 
             */
   
            var data = {
                id: id,
                controlsButtonsId: &quot;controlsButtons_&quot; + id,
                invertColoursId: invertColours,
                zoomInId: zoomIn,
                zoomOutId: zoomOut,
                resetId: reset,
                selectorWrapId: &quot;selectorWrap_&quot; + id,
                vselectorId: vselector,
                windowLevelId: windowLevel 
            };
            
            var source   = $(&quot;#slice_controls_template&quot;).html();
            var template = Handlebars.compile(source);
            return template(data);
        };


        function replaceVolume(volumePath) {
            /**
             * Replace current specimen volume with another.
             * Destroys current object (not sure is necessary) add new path and call setupoRenderers
             * 
             * @method replaceVolume
             * @param {String} VolumePath path to new volume to load into viewer
             */
            if (typeof (xRen) !== &#x27;undefined&#x27;) {
                xRen.destroy();
                delete xRen;
            }
            if (typeof (yRen) !== &#x27;undefined&#x27;) {
                yRen.destroy();
                delete yRen;
            }
            if (typeof (zRen) !== &#x27;undefined&#x27;) {
                zRen.destroy();
                delete zRen;
            }
            currentVolumePath = volumePath;
            setupRenderers();
        };


        function setupRenderers() {
            /**
             * Call the XTK functions that are required to get our volume rendered in 2D
             * 
             * @method setupRenderers
             */

            if (volumePaths.length &lt; 1) return;
            
            xRen = new X.renderer2D();
            xRen.container = $xContainer.get(0);
            xRen.orientation = &#x27;X&#x27;;
            xRen.init();

            yRen = new X.renderer2D();
            yRen.container = $yContainer.get(0);
            yRen.orientation = &#x27;Y&#x27;;
            yRen.init();

            zRen = new X.renderer2D();
            zRen.container = $zContainer.get(0);
            zRen.orientation = &#x27;Z&#x27;;
            zRen.init();

            //
            // THE VOLUME DATA
            //
            // create a X.volume
            volume = new X.volume();
            volume.file = currentVolumePath;

            xRen.add(volume);
            

            xRen.render();

            xRen.onShowtime = xtk_showtime;

           
        };


        function invertColour(checked) {
            /**
             * Responds to invert color checkbox, and inverts the lookup table
             * 
             * @method invertColour
             * @param {bool} checked Is the checkbox active
             */

            if (!volume)
                return;

            if (checked) {
                volume.maxColor = [0, 0, 0];
                volume.minColor = [1, 1, 1];
                $(&quot;#&quot; + id + &quot;&gt; .sliceView&quot;).css(&quot;background-color&quot;, &quot;#FFFFFF&quot;);

                volume.indexX++;
                volume.indexY++;
                volume.indexZ++;

            } else {

                volume.maxColor = [1, 1, 1];
                volume.minColor = [0, 0, 0];
                $(&quot;#&quot; + id + &quot;&gt; .sliceView&quot;).css(&quot;background-color&quot;, &quot;#000000&quot;);

                // Bodge to get the colours to update
                volume.indexX--;
                volume.indexY--;
                volume.indexZ--;
            }
        };
        
        
        
       function sliceChange(id, ortho, index){
           /**
            * Called when the slice index is changed either from the slider of the mouse scroll button
            * 
            * @method sliceChange
            * @param {int} id The ID of the this SpecimenView class
            * @param {String} ortho The orthogonal view that was changed (&#x27;X&#x27;, &#x27;Y&#x27;, or &#x27;Z&#x27;)
            */
            if (ortho === &#x27;X&#x27;) indexCallback(id, ortho, index + xOffset );
            if (ortho === &#x27;Y&#x27;) indexCallback(id, ortho, index + yOffset );
            if (ortho === &#x27;Z&#x27;) indexCallback(id, ortho, index + zOffset );
       }
          


        function updateSliders(renderer) {
            /**
             * Update the slice index or contrast sliders.
             * If the shift key is down, we want to move the other orthogonal views index correspondingly
             * If the left mouse button is down, we are changing the contrast, so update the contrast sliders
             * 
             *  @method updateSliders
             *  @param {X.renderer2D} renderer The renderer from which the event came from. Contains the event
             *  @param {type} name description 
             * 
             */
 
            if (renderer.interactor.mousemoveEvent.shiftKey) {  
                //Cross-hair navigating///////////////////
                
                //Set the index sliders
                $xSlider.slider(&quot;value&quot;, volume.indexX);
                $ySlider.slider(&quot;value&quot;, volume.indexY);
                $zSlider.slider(&quot;value&quot;, volume.indexZ);   
                //Set the index in the other linked views
                sliceChange(id, &#x27;X&#x27;, volume.indexX);
                sliceChange(id, &#x27;Y&#x27;, volume.indexY);
                sliceChange(id, &#x27;Z&#x27;, volume.indexZ);
            }
            else if(renderer.interactor.leftButtonDown){
                  $windowLevel.slider(&quot;option&quot;, &quot;values&quot;, [volume.windowLow, volume.windowHigh]);
            }
    }



        function xtk_showtime() {
            /**
             * Gets executed after all files were fully loaded and just before the first rendering attempt.
             * Sets up: Volumes and their index to view, index sliders, and mouse whell events
             * 
             * @method xtk_showtime
             */

            yRen.add(volume);
            yRen.render();
            zRen.add(volume);
            zRen.render();

            var dims = volume.dimensions;

            // It appears that dimensoins are in yxz order. At least with nii loading
            volume.indexX = Math.floor((dims[0] - 1) / 2);
            volume.indexY = Math.floor((dims[1] - 1) / 2);
            volume.indexZ = Math.floor((dims[2] - 1) / 2);
            // Setup the sliders within &#x27;onShowtime&#x27; as we need the volume dimensions for the ranges


            // make the sliders
            $xSlider.slider({
                disabled: false,
                range: &quot;min&quot;,
                min: 0,
                max: dims[0] - 1,
                value: volume.indexX,
                slide: function (event, ui) {
                    if (!volume) {
                        return;
                    }
                    volume.indexX = ui.value;
                    sliceChange(id, &#x27;X&#x27;, volume.indexX);
                }.bind(this)
            });


            $ySlider.slider({
                disabled: false,
                range: &quot;min&quot;,
                min: 0,
                max: dims[1] - 1,
                value: volume.indexY,
                slide: function (event, ui) {
                    if (!volume) {
                        return;
                    }
                    volume.indexY = ui.value;
                    sliceChange(id, &#x27;Y&#x27;, volume.indexY);
                }.bind(this)
            });


            $zSlider.slider({
                disabled: false,
                range: &quot;min&quot;,
                min: 0,
                max: dims[2] - 1,
                value: volume.indexZ,
                slide: function (event, ui) {
                    if (!volume) {
                        return;
                    }
                    volume.indexZ = ui.value;
                    sliceChange(id, &#x27;Z&#x27;, volume.indexZ);
                }.bind(this)
            });

            // Overload onMouseWheel event to control slice sliders
            xRen.interactor.onMouseWheel = function (event) {
                $xSlider.slider({value: volume.indexX});
                sliceChange(id, &#x27;X&#x27;, volume.indexX);
            }.bind(this);

            yRen.interactor.onMouseWheel = function (event) {
                $ySlider.slider({value: volume.indexY});
                sliceChange(id, &#x27;Y&#x27;, volume.indexY);
            }.bind(this);

            zRen.interactor.onMouseWheel = function (event) {
                $zSlider.slider({value: volume.indexZ});
                sliceChange(id, &#x27;Z&#x27;, volume.indexZ);
            }.bind(this);

            // Overload sliceX mouse moved
            xRen.interactor.onMouseMove = function (event) {
                updateSliders(xRen, event);
            }.bind(this);

            // Overload yRen mouse moved
            yRen.interactor.onMouseMove = function (event) {
                updateSliders(yRen, event);
            }.bind(this);

            // Overload zRen mouse moved
            zRen.interactor.onMouseMove = function (event) {
                updateSliders(zRen, event);
            }.bind(this);
        };
        
        function setXindex(index){
            /**
             * Set the volume index for the X orientation
             * Apply the offset used in linking orthogonal views across SpecimenViews
             * @method setIndex
             * @param {int} index The new slice index to set
             */
             volume.indexX = index -xOffset;
             $xSlider.slider(&quot;value&quot;, volume.indexX);
        }
        
        function setYindex(index){
            /**
             * Set the volume index for the Y orientation
             * Apply the offset used in linking orthogonal views across SpecimenViews
             * @method setIndex
             * @param {int} index The new slice index to set
             */
             volume.indexY = index - yOffset;
             $ySlider.slider(&quot;value&quot;, volume.indexY);
        }
        
        function setZindex(index){
            /**
             * Set the volume index for the Z orientation
             * Apply the offset used in linking orthogonal views across SpecimenViews
             * @method setIndex
             * @param {int} index The new slice index to set
             */
             volume.indexZ = index - zOffset;
             $zSlider.slider(&quot;value&quot;, volume.indexZ);
        }
        
        function getIndex(ortho){
            /**
             * Get the index of the current slice for a orthogonal view
             * @method getIndex
             * @param {String} ortho Orthogonal view (&#x27;x&#x27;, &#x27;Y&#x27; or &#x27;Z&#x27;)
             */
            if (ortho === &#x27;X&#x27;) return volume.indexX;
            if (ortho === &#x27;Y&#x27;) return volume.indexY;
            if (ortho === &#x27;Z&#x27;) return volume.indexZ;
        }
       
        function setIdxOffset(ortho, offset){
            /**
             * Set the index offset for a specific orthogonal view.
             * The offset defines how much the slice index differs compared to the corresponding slice in the
             * other view
             */
            if (ortho === &#x27;X&#x27;) xOffset = offset;
            if (ortho === &#x27;Y&#x27;) yOffset = offset;
            if (ortho === &#x27;Z&#x27;) zOffset = offset;
        }
        



        function setVisibleViews(viewList, count, horizontalView) {
            /**
             * Set which orthogonal views should be visible. Change the container width
             * to take up the full width of the outer container.
             * If orientation in vertical, slice width should always be 100%
             * @method setVisibleViews
             * @param {Hash} viewsList Info on which orthogonal view is visible
             * @param {int} count How many views should be visible
             */
     
            var slice_view_width;
            
            if (horizontalView){
                slice_view_width = 100;
            }
            else{
                var slice_view_width = String(100 / count);
            }

            if (viewList[&#x27;X&#x27;].visible) {
                $xWrap.show();
                $xWrap.width(slice_view_width + &#x27;%&#x27;);

            } else {
                $xWrap.hide();
            }

            if (viewList[&#x27;Y&#x27;].visible) {
                $yWrap.show();
                $yWrap.width(slice_view_width + &#x27;%&#x27;);
           
            } else {
                $yWrap.hide();
            }

            if (viewList[&#x27;Z&#x27;].visible) {
                $zWrap.show();
                $zWrap.width(slice_view_width + &#x27;%&#x27;);
          
            } else {
                $zWrap.hide();
            }
        };


        function basename(path) {
            /**
             * Extract the basename from a path
             * @method basename
             * @param {String} path File path
             */
            return path.split(/[\\/]/).pop();
        };


        var public_interface = {
            /**
             * The public interface for this class.
             * refernce public methods in here
             * @type {Object}
             */
            setVisibleViews: setVisibleViews,
            setXindex: setXindex,
            setYindex: setYindex,
            setZindex: setZindex,
            getIndex: getIndex,
            id: id,
            setIdxOffset: setIdxOffset

        };
        
        createHTML();
        jQuerySelectors();
        setupRenderers();
        createEventHandlers();
        return public_interface;
    }

    dcc.SpecimenView = SpecimenView;
})();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
